<!doctype html>
<html class="docs-version-2.6.0" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Pulsar RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Pulsar Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Pulsar" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;600&display=swap">
<script src="https://cdn.jsdelivr.net/npm/sine-waves@0.3.0/sine-waves.min.js" async></script><title data-react-helmet="true">Topic compaction | Apache Pulsar</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pulsar.apache.org/docs/2.6.0/cookbooks-compaction"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="2.6.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-2.6.0"><meta data-react-helmet="true" property="og:title" content="Topic compaction | Apache Pulsar"><meta data-react-helmet="true" name="description" content="Pulsar&#x27;s topic compaction feature enables you to create compacted topics in which older, &quot;obscured&quot; entries are pruned from the topic, allowing for faster reads through the topic&#x27;s history (which messages are deemed obscured/outdated/irrelevant will depend on your use case)."><meta data-react-helmet="true" property="og:description" content="Pulsar&#x27;s topic compaction feature enables you to create compacted topics in which older, &quot;obscured&quot; entries are pruned from the topic, allowing for faster reads through the topic&#x27;s history (which messages are deemed obscured/outdated/irrelevant will depend on your use case)."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pulsar.apache.org/docs/2.6.0/cookbooks-compaction"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/docs/2.6.0/cookbooks-compaction" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/zh-CN/docs/2.6.0/cookbooks-compaction" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/zh-TW/docs/2.6.0/cookbooks-compaction" hreflang="zh-TW"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/ja/docs/2.6.0/cookbooks-compaction" hreflang="ja"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/fr/docs/2.6.0/cookbooks-compaction" hreflang="fr"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/ko/docs/2.6.0/cookbooks-compaction" hreflang="ko"><link data-react-helmet="true" rel="alternate" href="https://pulsar.apache.org/docs/2.6.0/cookbooks-compaction" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.699273c6.css">
<link rel="preload" href="/assets/js/runtime~main.fb3ed37d.js" as="script">
<link rel="preload" href="/assets/js/main.94d7d9ef.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="tailwind navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="pulasr logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="pulasr logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Get Started</a><ul class="dropdown__menu"><li><a class="dropdown__link navbar__link--active" href="/docs/2.6.0/concepts-overview">Pulsar Concepts</a></li><li><a class="dropdown__link navbar__link--active" href="/docs/2.6.0/about">Quickstart</a></li><li><a class="dropdown__link" href="/ecosystem">Ecosystem</a></li></ul></div><a class="navbar__item navbar__link navbar__link--active" href="/docs/2.6.0/about">Docs</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">REST APIs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/admin-rest-api">Admin REST API</a></li><li><a class="dropdown__link" href="/functions-rest-api">Functions</a></li><li><a class="dropdown__link" href="/source-rest-api">Sources</a></li><li><a class="dropdown__link" href="/sink-rest-api">Sinks</a></li><li><a class="dropdown__link" href="/packages-rest-api">Packages</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">CLI</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/pulsar-admin-cli">Pulsar Admin</a></li><li><a class="dropdown__link" href="/pulsar-client-cli">Pulsar Client</a></li><li><a class="dropdown__link" href="/pulsar-perf-cli">Pulsar Perf</a></li><li><a class="dropdown__link" href="/pulsar-cli">Pulsar</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community#welcome">Welcome</a></li><li><a class="dropdown__link" href="/community#discussions">Discussions</a></li><li><a class="dropdown__link" href="/community#governance">Governance</a></li><li><a class="dropdown__link" href="/community#community">Meet the Community</a></li><li><a class="dropdown__link" href="/community#how-to-contribute">Contribute</a></li><li><a href="https://github.com/apache/pulsar/wiki" target="_blank" rel="noopener noreferrer" class="dropdown__link">Wiki</a></li><li><a href="https://github.com/apache/pulsar/issues" target="_blank" rel="noopener noreferrer" class="dropdown__link">Issue Tracking</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog">Blog</a></li><li><a class="dropdown__link" href="/case-studies">Case Studies</a></li><li><a class="dropdown__link" href="/resources">Resources</a></li><li><a class="dropdown__link" href="/events">Events</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_zID8"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/zh-CN/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link">‰∏≠ÊñáÔºà‰∏≠ÂõΩÔºâ</a></li><li><a href="/zh-TW/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link">‰∏≠ÊñáÔºàÂè∞ÁÅ£Ôºâ</a></li><li><a href="/ja/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link">Êó•Êú¨Ë™û</a></li><li><a href="/fr/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link">Fran√ßais</a></li><li><a href="/ko/docs/2.6.0/cookbooks-compaction" target="_self" rel="noopener noreferrer" class="dropdown__link">ÌïúÍµ≠Ïñ¥</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs">Version</a><ul class="dropdown__menu"><li><a rel="noopener noreferrer" class="dropdown__link"><span>2.9.0</span></a></li><li><a rel="noopener noreferrer" class="dropdown__link"><span>2.8.0</span></a></li><li><a rel="noopener noreferrer" class="dropdown__link"><span>2.7.0</span></a></li><li><a rel="noopener noreferrer" class="dropdown__link"><span>2.6.0</span></a></li></ul></div><div class="toggle_iYfV toggle_iQ2x toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/2.6.0/about">About</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/pulsar-2.0">Get Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/concepts-overview">Concepts and Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/schema-get-started">Pulsar Schema</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/functions-overview">Pulsar Functions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/io-overview">Pulsar IO</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/sql-overview">Pulsar SQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/helm-overview">Kubernetes (Helm)</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/deploy-aws">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/administration-zk-bk">Administration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/security-overview">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/performance-pulsar-perf">Performance</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/client-libraries-java">Client Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/admin-api-overview">Admin API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/adaptors-kafka">Adaptors</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/2.6.0/cookbooks-tiered-storage">Cookbooks</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-tiered-storage">Tiered Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2.6.0/cookbooks-compaction">Topic compaction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-deduplication">Message deduplication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-non-persistent">Non-persistent messaging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-partitioned">Partitioned Topics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-retention-expiry">Message retention and expiry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-encryption">Encryption</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-message-queue">Message queue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.6.0/cookbooks-bookkeepermetadata">BookKeeper Ledger Metadata</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/develop-tools">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/2.6.0/reference-terminology">Reference</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Apache Pulsar<!-- --> <b>2.6.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/cookbooks-compaction">latest version</a></b> (<!-- -->2.9.1<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->2.6.0</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Topic compaction</h1></header><p>Pulsar&#x27;s <a href="/docs/2.6.0/concepts-topic-compaction#compaction">topic compaction</a> feature enables you to create <strong>compacted</strong> topics in which older, &quot;obscured&quot; entries are pruned from the topic, allowing for faster reads through the topic&#x27;s history (which messages are deemed obscured/outdated/irrelevant will depend on your use case).</p><p>To use compaction:</p><ul><li>You need to give messages keys, as topic compaction in Pulsar takes place on a <em>per-key basis</em> (i.e. messages are compacted based on their key). For a stock ticker use case, the stock symbol---e.g. <code>AAPL</code> or <code>GOOG</code>---could serve as the key (more on this <a href="#when-should-i-use-compacted-topics">below</a>). Messages without keys will be left alone by the compaction process.</li><li>Compaction can be configured to run <a href="#configuring-compaction-to-run-automatically">automatically</a>, or you can manually <a href="#trigger">trigger</a> compaction using the Pulsar administrative API.</li><li>Your consumers must be <a href="#consumer-configuration">configured</a> to read from compacted topics (<a href="#java">Java consumers</a>, for example, have a <code>readCompacted</code> setting that must be set to <code>true</code>). If this configuration is not set, consumers will still be able to read from the non-compacted topic.</li></ul><blockquote><p>Compaction only works on messages that have keys (as in the stock ticker example the stock symbol serves as the key for each message). Keys can thus be thought of as the axis along which compaction is applied. Messages that don&#x27;t have keys are simply ignored by compaction.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="when-should-i-use-compacted-topics">When should I use compacted topics?<a class="hash-link" href="#when-should-i-use-compacted-topics" title="Direct link to heading">‚Äã</a></h2><p>The classic example of a topic that could benefit from compaction would be a stock ticker topic through which consumers can access up-to-date values for specific stocks. Imagine a scenario in which messages carrying stock value data use the stock symbol as the key (<code>GOOG</code>, <code>AAPL</code>, <code>TWTR</code>, etc.). Compacting this topic would give consumers on the topic two options:</p><ul><li>They can read from the &quot;original,&quot; non-compacted topic in case they need access to &quot;historical&quot; values, i.e. the entirety of the topic&#x27;s messages.</li><li>They can read from the compacted topic if they only want to see the most up-to-date messages.</li></ul><p>Thus, if you&#x27;re using a Pulsar topic called <code>stock-values</code>, some consumers could have access to all messages in the topic (perhaps because they&#x27;re performing some kind of number crunching of all values in the last hour) while the consumers used to power the real-time stock ticker only see the compacted topic (and thus aren&#x27;t forced to process outdated messages). Which variant of the topic any given consumer pulls messages from is determined by the consumer&#x27;s <a href="#consumer-configuration">configuration</a>.</p><blockquote><p>One of the benefits of compaction in Pulsar is that you aren&#x27;t forced to choose between compacted and non-compacted topics, as the compaction process leaves the original topic as-is and essentially adds an alternate topic. In other words, you can run compaction on a topic and consumers that need access to the non-compacted version of the topic will not be adversely affected.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_y2LR" id="configuring-compaction-to-run-automatically">Configuring compaction to run automatically<a class="hash-link" href="#configuring-compaction-to-run-automatically" title="Direct link to heading">‚Äã</a></h2><p>Tenant administrators can configure a policy for compaction at the namespace level. The policy specifies how large the topic backlog can grow before compaction is triggered.</p><p>For example, to trigger compaction when the backlog reaches 100MB:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar-admin namespaces set-compaction-threshold </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --threshold 100M my-tenant/my-namespace</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Configuring the compaction threshold on a namespace will apply to all topics within that namespace.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="triggering-compaction-manually">Triggering compaction manually<a class="hash-link" href="#triggering-compaction-manually" title="Direct link to heading">‚Äã</a></h2><p>In order to run compaction on a topic, you need to use the <a href="/docs/2.6.0/reference-pulsar-admin.md#topics-compact"><code>topics compact</code></a> command for the <a href="/docs/2.6.0/reference-pulsar-admin"><code>pulsar-admin</code></a> CLI tool. Here&#x27;s an example:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar-admin topics compact </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  persistent://my-tenant/my-namespace/my-topic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>pulsar-admin</code> tool runs compaction via the Pulsar <a href="https://pulsar.apache.org/admin-rest-api#/" target="_blank" rel="noopener noreferrer">REST</a> API. To run compaction in its own dedicated process, i.e. <em>not</em> through the REST API, you can use the <a href="/docs/2.6.0/reference-cli-tools#pulsar-compact-topic"><code>pulsar compact-topic</code></a> command. Here&#x27;s an example:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar compact-topic </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --topic persistent://my-tenant-namespace/my-topic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><blockquote><p>Running compaction in its own process is recommended when you want to avoid interfering with the broker&#x27;s performance. Broker performance should only be affected, however, when running compaction on topics with a large keyspace (i.e when there are many keys on the topic). The first phase of the compaction process keeps a copy of each key in the topic, which can create memory pressure as the number of keys grows. Using the <code>pulsar-admin topics compact</code> command to run compaction through the REST API should present no issues in the overwhelming majority of cases; using <code>pulsar compact-topic</code> should correspondingly be considered an edge case.</p></blockquote><p>The <code>pulsar compact-topic</code> command communicates with <a href="https://zookeeper.apache.org" target="_blank" rel="noopener noreferrer">ZooKeeper</a> directly. In order to establish communication with ZooKeeper, though, the <code>pulsar</code> CLI tool will need to have a valid <a href="/docs/2.6.0/reference-configuration#broker">broker configuration</a>. You can either supply a proper configuration in <code>conf/broker.conf</code> or specify a non-default location for the configuration:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar compact-topic </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --broker-conf /path/to/broker.conf </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --topic persistent://my-tenant/my-namespace/my-topic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># If the configuration is in conf/broker.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ bin/pulsar compact-topic </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --topic persistent://my-tenant/my-namespace/my-topic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="when-should-i-trigger-compaction">When should I trigger compaction?<a class="hash-link" href="#when-should-i-trigger-compaction" title="Direct link to heading">‚Äã</a></h4><p>How often you <a href="#triggering-compaction-manually">trigger compaction</a> will vary widely based on the use case. If you want a compacted topic to be extremely speedy on read, then you should run compaction fairly frequently.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="consumer-configuration">Consumer configuration<a class="hash-link" href="#consumer-configuration" title="Direct link to heading">‚Äã</a></h2><p>Pulsar consumers and readers need to be configured to read from compacted topics. The sections below show you how to enable compacted topic reads for Pulsar&#x27;s language clients. If the</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="java">Java<a class="hash-link" href="#java" title="Direct link to heading">‚Äã</a></h3><p>In order to read from a compacted topic using a Java consumer, the <code>readCompacted</code> parameter must be set to <code>true</code>. Here&#x27;s an example consumer for a compacted topic:</p><div class="codeBlockContainer_J+bg language-java theme-code-block"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Consumer&lt;byte[]&gt; compactedTopicConsumer = client.newConsumer()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .topic(&quot;some-compacted-topic&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .readCompacted(true)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .subscribe();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As mentioned above, topic compaction in Pulsar works on a <em>per-key basis</em>. That means that messages that you produce on compacted topics need to have keys (the content of the key will depend on your use case). Messages that don&#x27;t have keys will be ignored by the compaction process. Here&#x27;s an example Pulsar message with a key:</p><div class="codeBlockContainer_J+bg language-java theme-code-block"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.Message;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.MessageBuilder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Message&lt;byte[]&gt; msg = MessageBuilder.create()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .setContent(someByteArray)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .setKey(&quot;some-key&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The example below shows a message with a key being produced on a compacted Pulsar topic:</p><div class="codeBlockContainer_J+bg language-java theme-code-block"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.Message;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.MessageBuilder;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.Producer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import org.apache.pulsar.client.api.PulsarClient;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">PulsarClient client = PulsarClient.builder()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .serviceUrl(&quot;pulsar://localhost:6650&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Producer&lt;byte[]&gt; compactedTopicProducer = client.newProducer()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .topic(&quot;some-compacted-topic&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .create();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Message&lt;byte[]&gt; msg = MessageBuilder.create()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .setContent(someByteArray)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .setKey(&quot;some-key&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">compactedTopicProducer.send(msg);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/pulsar/edit/master/site2/website-next/versioned_docs/version-2.6.0/cookbooks-compaction.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/2.6.0/cookbooks-tiered-storage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Tiered Storage</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/2.6.0/cookbooks-deduplication"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Message deduplication</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#when-should-i-use-compacted-topics" class="table-of-contents__link toc-highlight">When should I use compacted topics?</a></li><li><a href="#configuring-compaction-to-run-automatically" class="table-of-contents__link toc-highlight">Configuring compaction to run automatically</a></li><li><a href="#triggering-compaction-manually" class="table-of-contents__link toc-highlight">Triggering compaction manually</a></li><li><a href="#consumer-configuration" class="table-of-contents__link toc-highlight">Consumer configuration</a><ul><li><a href="#java" class="table-of-contents__link toc-highlight">Java</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Apache Foundation.</div><ul class="footer__items"><li class="footer__item">
	              <img src="/img/Apache_Feather_Logo.svg" alt="" width="20">
	              </li><li class="footer__item"><a href="http://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Foundation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>License<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Thanks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.apache.org/security" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Security<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Sponsorship<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title"> </div><ul class="footer__items"><li class="footer__item">
	              <div><small><strong>Apache Pulsar is available under the <a href="/">Apache License, version 2.0.</a></strong></small></div>
                <div>Apache Pulsar is a distributed, open source pub-sub messaging and streaming platform for real-time workloads, managing hundreds of billions of events per day.</div>
	              </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_SRtH" href="/"><img src="/img/pulsar-white.svg" alt="Pulsar Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/pulsar-white.svg" alt="Pulsar Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright"><p>Apache Pulsar is available under the Apache License, version 2.0.</p>
      <p>Copyright ¬© 2022 The Apache Software Foundation. All Rights Reserved. Apache, Apache Pulsar and the Apache feather logo are trademarks of The Apache Software Foundation.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.fb3ed37d.js"></script>
<script src="/assets/js/main.94d7d9ef.js"></script>
</body>
</html>