"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[2420],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=u(n),d=o,g=m["".concat(s,".").concat(d)]||m[d]||c[d]||r;return n?a.createElement(g,i(i({ref:t},p),{},{components:n})):a.createElement(g,i({ref:t},p))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var u=2;u<r;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),o=n(86010);const r="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(r,i),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>d});var a=n(87462),o=n(67294),r=n(86010),i=n(72389),l=n(67392),s=n(7094),u=n(12466);const p="tabList__CuJ",c="tabItem_LNqP";function m(e){var t;const{lazy:n,block:i,defaultValue:m,values:d,groupId:g,className:f}=e,h=o.Children.map(e.children,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),k=d??h.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),y=(0,l.l)(k,((e,t)=>e.value===t.value));if(y.length>0)throw new Error(`Docusaurus error: Duplicate values "${y.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const v=null===m?m:m??(null==(t=h.find((e=>e.props.default)))?void 0:t.props.value)??h[0].props.value;if(null!==v&&!k.some((e=>e.value===v)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${v}" but none of its children has the corresponding value. Available values are: ${k.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:b,setTabGroupChoices:N}=(0,s.U)(),[C,x]=(0,o.useState)(v),w=[],{blockElementScrollPositionUntilNextRender:S}=(0,u.o5)();if(null!=g){const e=b[g];null!=e&&e!==C&&k.some((t=>t.value===e))&&x(e)}const T=e=>{const t=e.currentTarget,n=w.indexOf(t),a=k[n].value;a!==C&&(S(t),x(a),null!=g&&N(g,String(a)))},P=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{const t=w.indexOf(e.currentTarget)+1;n=w[t]??w[0];break}case"ArrowLeft":{const t=w.indexOf(e.currentTarget)-1;n=w[t]??w[w.length-1];break}}null==(t=n)||t.focus()};return o.createElement("div",{className:(0,r.Z)("tabs-container",p)},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":i},f)},k.map((e=>{let{value:t,label:n,attributes:i}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:C===t?0:-1,"aria-selected":C===t,key:t,ref:e=>w.push(e),onKeyDown:P,onFocus:T,onClick:T},i,{className:(0,r.Z)("tabs__item",c,null==i?void 0:i.className,{"tabs__item--active":C===t})}),n??t)}))),n?(0,o.cloneElement)(h.filter((e=>e.props.value===C))[0],{className:"margin-top--md"}):o.createElement("div",{className:"margin-top--md"},h.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==C})))))}function d(e){const t=(0,i.Z)();return o.createElement(m,(0,a.Z)({key:String(t)},e))}},63664:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>u,toc:()=>c});var a=n(87462),o=(n(67294),n(3905)),r=n(65488),i=n(85162);const l={id:"functions-develop",title:"Develop Pulsar Functions",sidebar_label:"How-to: Develop",original_id:"functions-develop"},s=void 0,u={unversionedId:"functions-develop",id:"version-2.6.0/functions-develop",title:"Develop Pulsar Functions",description:"This tutorial walks you through how to develop Pulsar Functions.",source:"@site/versioned_docs/version-2.6.0/functions-develop.md",sourceDirName:".",slug:"/functions-develop",permalink:"/docs/2.6.0/functions-develop",draft:!1,editUrl:"https://github.com/apache/pulsar/edit/master/site2/docs/functions-develop.md",tags:[],version:"2.6.0",frontMatter:{id:"functions-develop",title:"Develop Pulsar Functions",sidebar_label:"How-to: Develop",original_id:"functions-develop"},sidebar:"version-2.6.0/docsSidebar",previous:{title:"Setup: Configure Functions runtime",permalink:"/docs/2.6.0/functions-runtime"},next:{title:"How-to: Debug",permalink:"/docs/2.6.0/functions-debug"}},p={},c=[{value:"Available APIs",id:"available-apis",level:2},{value:"Schema registry",id:"schema-registry",level:2},{value:"SerDe",id:"serde",level:2},{value:"Example",id:"example",level:3},{value:"Context",id:"context",level:2},{value:"User config",id:"user-config",level:3},{value:"Logger",id:"logger",level:3},{value:"Metrics",id:"metrics",level:2},{value:"Access metrics",id:"access-metrics",level:3},{value:"Security",id:"security",level:2},{value:"State storage",id:"state-storage",level:2},{value:"API",id:"api",level:3},{value:"incrCounter",id:"incrcounter",level:4},{value:"incrCounterAsync",id:"incrcounterasync",level:4},{value:"getCounter",id:"getcounter",level:4},{value:"getCounterAsync",id:"getcounterasync",level:4},{value:"putState",id:"putstate",level:4},{value:"putStateAsync",id:"putstateasync",level:4},{value:"getState",id:"getstate",level:4},{value:"getStateAsync",id:"getstateasync",level:4},{value:"deleteState",id:"deletestate",level:4},{value:"incr_counter",id:"incr_counter",level:4},{value:"get_counter",id:"get_counter",level:4},{value:"put_state",id:"put_state",level:4},{value:"get_state",id:"get_state",level:4},{value:"del_counter",id:"del_counter",level:4},{value:"Query State",id:"query-state",level:3},{value:"Example",id:"example-1",level:3}],m={toc:c};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"This tutorial walks you through how to develop Pulsar Functions."),(0,o.kt)("h2",{id:"available-apis"},"Available APIs"),(0,o.kt)("p",null,"In Java and Python, you have two options to write Pulsar Functions. In Go, you can use Pulsar Functions SDK for Go."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:"left"},"Interface"),(0,o.kt)("th",{parentName:"tr",align:"left"},"Description"),(0,o.kt)("th",{parentName:"tr",align:"left"},"Use cases"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"Language-native interface"),(0,o.kt)("td",{parentName:"tr",align:"left"},"No Pulsar-specific libraries or special dependencies required (only core libraries from Java/Python)."),(0,o.kt)("td",{parentName:"tr",align:"left"},"Functions that do not require access to the function ",(0,o.kt)("a",{parentName:"td",href:"#context"},"context"),".")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"Pulsar Function SDK for Java/Python/Go"),(0,o.kt)("td",{parentName:"tr",align:"left"},'Pulsar-specific libraries that provide a range of functionality not provided by "native" interfaces.'),(0,o.kt)("td",{parentName:"tr",align:"left"},"Functions that require access to the function ",(0,o.kt)("a",{parentName:"td",href:"#context"},"context"),".")))),(0,o.kt)("p",null,"The language-native function, which adds an exclamation point to all incoming strings and publishes the resulting string to a topic, has no external dependencies. The following example is language-native function."),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-Java"},'\nimport java.util.function.Function;\n\npublic class JavaNativeExclamationFunction implements Function<String, String> {\n    @Override\n    public String apply(String input) {\n        return String.format("%s!", input);\n    }\n}\n\n')),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/JavaNativeExclamationFunction.java"},"here"),".")),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\ndef process(input):\n    return "{}!".format(input)\n\n')),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/native_exclamation_function.py"},"here"),"."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"You can write Pulsar Functions in python2 or python3. However, Pulsar only looks for ",(0,o.kt)("inlineCode",{parentName:"p"},"python")," as the interpreter.\nIf you're running Pulsar Functions on an Ubuntu system that only supports python3, you might fail to\nstart the functions. In this case, you can create a symlink. Your system will fail if\nyou subsequently install any other package that depends on Python 2.x. A solution is under development in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/issues/5518"},"Issue 5518"),"."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\nsudo update-alternatives --install /usr/bin/python python /usr/bin/python3 10\n\n"))))),(0,o.kt)("p",null,"The following example uses Pulsar Functions SDK."),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-Java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\n\npublic class ExclamationFunction implements Function<String, String> {\n    @Override\n    public String process(String input, Context context) {\n        return String.format("%s!", input);\n    }\n}\n\n')),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/ExclamationFunction.java"},"here"),".")),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import Function\n\nclass ExclamationFunction(Function):\n  def __init__(self):\n    pass\n\n  def process(self, input, context):\n    return input + '!'\n\n")),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/exclamation_function.py"},"here"),".")),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-Go"},'\npackage main\n\nimport (\n    "context"\n    "fmt"\n\n    "github.com/apache/pulsar/pulsar-function-go/pf"\n)\n\nfunc HandleRequest(ctx context.Context, in []byte) error{\n    fmt.Println(string(in) + "!")\n    return nil\n}\n\nfunc main() {\n    pf.Start(HandleRequest)\n}\n\n')),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/77cf09eafa4f1626a53a1fe2e65dd25f377c1127/pulsar-function-go/examples/inputFunc/inputFunc.go#L20-L36"},"here"),"."))),(0,o.kt)("h2",{id:"schema-registry"},"Schema registry"),(0,o.kt)("p",null,"Pulsar has a built in schema registry and comes bundled with a variety of popular schema types(avro, json and protobuf). Pulsar Functions can leverage existing schema information from input topics and derive the input type. The schema registry applies for output topic as well."),(0,o.kt)("h2",{id:"serde"},"SerDe"),(0,o.kt)("p",null,"SerDe stands for ",(0,o.kt)("strong",{parentName:"p"},"Ser"),"ialization and ",(0,o.kt)("strong",{parentName:"p"},"De"),"serialization. Pulsar Functions uses SerDe when publishing data to and consuming data from Pulsar topics. How SerDe works by default depends on the language you use for a particular function."),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"When you write Pulsar Functions in Java, the following basic Java types are built in and supported by default:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"String")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Double")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Integer")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Float")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Long")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Short")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Byte"))),(0,o.kt)("p",null,"To customize Java types, you need to implement the following interface."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\npublic interface SerDe<T> {\n    T deserialize(byte[] input);\n    byte[] serialize(T input);\n}\n\n"))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"In Python, the default SerDe is identity, meaning that the type is serialized as whatever type the producer function returns."),(0,o.kt)("p",null,"You can specify the SerDe when ",(0,o.kt)("a",{parentName:"p",href:"functions-deploy.md#cluster-mode"},"creating")," or ",(0,o.kt)("a",{parentName:"p",href:"functions-deploy.md#local-run-mode"},"running")," functions. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'\n$ bin/pulsar-admin functions create \\\n  --tenant public \\\n  --namespace default \\\n  --name my_function \\\n  --py my_function.py \\\n  --classname my_function.MyFunction \\\n  --custom-serde-inputs \'{"input-topic-1":"Serde1","input-topic-2":"Serde2"}\' \\\n  --output-serde-classname Serde3 \\\n  --output output-topic-1\n\n')),(0,o.kt)("p",null,"This case contains two input topics: ",(0,o.kt)("inlineCode",{parentName:"p"},"input-topic-1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"input-topic-2"),", each of which is mapped to a different SerDe class (the map must be specified as a JSON string). The output topic, ",(0,o.kt)("inlineCode",{parentName:"p"},"output-topic-1"),", uses the ",(0,o.kt)("inlineCode",{parentName:"p"},"Serde3")," class for SerDe. At the moment, all Pulsar Functions logic, include processing function and SerDe classes, must be contained within a single Python file."),(0,o.kt)("p",null,"When using Pulsar Functions for Python, you have three SerDe options:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"You can use the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L70"},(0,o.kt)("inlineCode",{parentName:"a"},"IdentitySerde")),", which leaves the data unchanged. The ",(0,o.kt)("inlineCode",{parentName:"li"},"IdentitySerDe")," is the ",(0,o.kt)("strong",{parentName:"li"},"default"),". Creating or running a function without explicitly specifying SerDe means that this option is used."),(0,o.kt)("li",{parentName:"ol"},"You can use the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L62"},(0,o.kt)("inlineCode",{parentName:"a"},"PickleSerDe")),", which uses Python ",(0,o.kt)("a",{parentName:"li",href:"https://docs.python.org/3/library/pickle.html"},(0,o.kt)("inlineCode",{parentName:"a"},"pickle"))," for SerDe."),(0,o.kt)("li",{parentName:"ol"},"You can create a custom SerDe class by implementing the baseline ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L50"},(0,o.kt)("inlineCode",{parentName:"a"},"SerDe"))," class, which has just two methods: ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L53"},(0,o.kt)("inlineCode",{parentName:"a"},"serialize"))," for converting the object into bytes, and ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/apache/pulsar/blob/master/pulsar-client-cpp/python/pulsar/functions/serde.py#L58"},(0,o.kt)("inlineCode",{parentName:"a"},"deserialize"))," for converting bytes into an object of the required application-specific type.")),(0,o.kt)("p",null,"The table below shows when you should use each SerDe."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:"left"},"SerDe option"),(0,o.kt)("th",{parentName:"tr",align:"left"},"When to use"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"IdentitySerde")),(0,o.kt)("td",{parentName:"tr",align:"left"},"When you work with simple types like strings, Booleans, integers.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"PickleSerDe")),(0,o.kt)("td",{parentName:"tr",align:"left"},'When you work with complex, application-specific types and are comfortable with the "best effort" approach of ',(0,o.kt)("inlineCode",{parentName:"td"},"pickle"),".")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},"Custom SerDe"),(0,o.kt)("td",{parentName:"tr",align:"left"},"When you require explicit control over SerDe, potentially for performance or data compatibility purposes."))))),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently, the feature is not available in Go."))),(0,o.kt)("h3",{id:"example"},"Example"),(0,o.kt)("p",null,"Imagine that you're writing Pulsar Functions that are processing tweet objects, you can refer to the following example of ",(0,o.kt)("inlineCode",{parentName:"p"},"Tweet")," class."),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\npublic class Tweet {\n    private String username;\n    private String tweetContent;\n\n    public Tweet(String username, String tweetContent) {\n        this.username = username;\n        this.tweetContent = tweetContent;\n    }\n\n    // Standard setters and getters\n}\n\n")),(0,o.kt)("p",null,"To pass ",(0,o.kt)("inlineCode",{parentName:"p"},"Tweet")," objects directly between Pulsar Functions, you need to provide a custom SerDe class. In the example below, ",(0,o.kt)("inlineCode",{parentName:"p"},"Tweet")," objects are basically strings in which the username and tweet content are separated by a ",(0,o.kt)("inlineCode",{parentName:"p"},"|"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\npackage com.example.serde;\n\nimport org.apache.pulsar.functions.api.SerDe;\n\nimport java.util.regex.Pattern;\n\npublic class TweetSerde implements SerDe<Tweet> {\n    public Tweet deserialize(byte[] input) {\n        String s = new String(input);\n        String[] fields = s.split(Pattern.quote("|"));\n        return new Tweet(fields[0], fields[1]);\n    }\n\n    public byte[] serialize(Tweet input) {\n        return "%s|%s".format(input.getUsername(), input.getTweetContent()).getBytes();\n    }\n}\n\n')),(0,o.kt)("p",null,"To apply this customized SerDe to a particular Pulsar Function, you need to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Package the ",(0,o.kt)("inlineCode",{parentName:"li"},"Tweet")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"TweetSerde")," classes into a JAR."),(0,o.kt)("li",{parentName:"ul"},"Specify a path to the JAR and SerDe class name when deploying the function.")),(0,o.kt)("p",null,"The following is an example of ",(0,o.kt)("a",{parentName:"p",href:"reference-pulsar-admin.md#create-1"},(0,o.kt)("inlineCode",{parentName:"a"},"create"))," operation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin functions create \\\n  --jar /path/to/your.jar \\\n  --output-serde-classname com.example.serde.TweetSerde \\\n  # Other function attributes\n\n")),(0,o.kt)("blockquote",null,(0,o.kt)("h4",{parentName:"blockquote",id:"custom-serde-classes-must-be-packaged-with-your-function-jars"},"Custom SerDe classes must be packaged with your function JARs"),(0,o.kt)("p",{parentName:"blockquote"},"Pulsar does not store your custom SerDe classes separately from your Pulsar Functions. So you need to include your SerDe classes in your function JARs. If not, Pulsar returns an error."))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nclass Tweet(object):\n    def __init__(self, username, tweet_content):\n        self.username = username\n        self.tweet_content = tweet_content\n\n")),(0,o.kt)("p",null,"In order to use this class in Pulsar Functions, you have two options:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"You can specify ",(0,o.kt)("inlineCode",{parentName:"p"},"PickleSerDe"),", which applies the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/pickle.html"},(0,o.kt)("inlineCode",{parentName:"a"},"pickle"))," library SerDe.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"You can create your own SerDe class. The following is an example."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import SerDe\n\nclass TweetSerDe(SerDe):\n\n    def serialize(self, input):\n        return bytes(\"{0}|{1}\".format(input.username, input.tweet_content))\n\n    def deserialize(self, input_bytes):\n        tweet_components = str(input_bytes).split('|')\n        return Tweet(tweet_components[0], tweet_componentsp[1])\n\n")))),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/python-examples/custom_object_function.py"},"here"),"."))),(0,o.kt)("p",null,"In both languages, however, you can write custom SerDe logic for more complex, application-specific types."),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("p",null,"Java, Python and Go SDKs provide access to a ",(0,o.kt)("strong",{parentName:"p"},"context object")," that can be used by a function. This context object provides a wide variety of information and functionality to the function."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The name and ID of a Pulsar Function."),(0,o.kt)("li",{parentName:"ul"},"The message ID of each message. Each Pulsar message is automatically assigned with an ID."),(0,o.kt)("li",{parentName:"ul"},"The key, event time, properties and partition key of each message."),(0,o.kt)("li",{parentName:"ul"},"The name of the topic to which the message is sent."),(0,o.kt)("li",{parentName:"ul"},"The names of all input topics as well as the output topic associated with the function."),(0,o.kt)("li",{parentName:"ul"},"The name of the class used for ",(0,o.kt)("a",{parentName:"li",href:"#serde"},"SerDe"),"."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("a",{parentName:"li",href:"/docs/2.6.0/reference-terminology#tenant"},"tenant")," and namespace associated with the function."),(0,o.kt)("li",{parentName:"ul"},"The ID of the Pulsar Functions instance running the function."),(0,o.kt)("li",{parentName:"ul"},"The version of the function."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("a",{parentName:"li",href:"/docs/2.6.0/functions-develop#logger"},"logger object")," used by the function, which can be used to create function log messages."),(0,o.kt)("li",{parentName:"ul"},"Access to arbitrary ",(0,o.kt)("a",{parentName:"li",href:"#user-config"},"user configuration")," values supplied via the CLI."),(0,o.kt)("li",{parentName:"ul"},"An interface for recording ",(0,o.kt)("a",{parentName:"li",href:"#metrics"},"metrics"),"."),(0,o.kt)("li",{parentName:"ul"},"An interface for storing and retrieving state in ",(0,o.kt)("a",{parentName:"li",href:"#state-storage"},"state storage"),"."),(0,o.kt)("li",{parentName:"ul"},"A function to publish new messages onto arbitrary topics."),(0,o.kt)("li",{parentName:"ul"},"A function to ack the message being processed (if auto-ack is disabled).")),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/master/pulsar-functions/api-java/src/main/java/org/apache/pulsar/functions/api/Context.java"},"Context")," interface provides a number of methods that you can use to access the function ",(0,o.kt)("a",{parentName:"p",href:"#context"},"context"),". The various method signatures for the ",(0,o.kt)("inlineCode",{parentName:"p"},"Context")," interface are listed as follows."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\npublic interface Context {\n    Record<?> getCurrentRecord();\n    Collection<String> getInputTopics();\n    String getOutputTopic();\n    String getOutputSchemaType();\n    String getTenant();\n    String getNamespace();\n    String getFunctionName();\n    String getFunctionId();\n    String getInstanceId();\n    String getFunctionVersion();\n    Logger getLogger();\n    void incrCounter(String key, long amount);\n    void incrCounterAsync(String key, long amount);\n    long getCounter(String key);\n    long getCounterAsync(String key);\n    void putState(String key, ByteBuffer value);\n    void putStateAsync(String key, ByteBuffer value);\n    void deleteState(String key);\n    ByteBuffer getState(String key);\n    ByteBuffer getStateAsync(String key);\n    Map<String, Object> getUserConfigMap();\n    Optional<Object> getUserConfigValue(String key);\n    Object getUserConfigValueOrDefault(String key, Object defaultValue);\n    void recordMetric(String metricName, double value);\n    <O> CompletableFuture<Void> publish(String topicName, O object, String schemaOrSerdeClassName);\n    <O> CompletableFuture<Void> publish(String topicName, O object);\n    <O> TypedMessageBuilder<O> newOutputMessage(String topicName, Schema<O> schema) throws PulsarClientException;\n    <O> ConsumerBuilder<O> newConsumerBuilder(Schema<O> schema) throws PulsarClientException;\n}\n\n")),(0,o.kt)("p",null,"The following example uses several methods available via the ",(0,o.kt)("inlineCode",{parentName:"p"},"Context")," object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\nimport org.slf4j.Logger;\n\nimport java.util.stream.Collectors;\n\npublic class ContextFunction implements Function<String, Void> {\n    public Void process(String input, Context context) {\n        Logger LOG = context.getLogger();\n        String inputTopics = context.getInputTopics().stream().collect(Collectors.joining(", "));\n        String functionName = context.getFunctionName();\n\n        String logMessage = String.format("A message with a value of \\"%s\\" has arrived on one of the following topics: %s\\n",\n                input,\n                inputTopics);\n\n        LOG.info(logMessage);\n\n        String metricName = String.format("function-%s-messages-received", functionName);\n        context.recordMetric(metricName, 1);\n\n        return null;\n    }\n}\n\n'))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'\nclass ContextImpl(pulsar.Context):\n  def get_message_id(self):\n    ...\n  def get_message_key(self):\n    ...\n  def get_message_eventtime(self):\n    ...\n  def get_message_properties(self):\n    ...\n  def get_current_message_topic_name(self):\n    ...\n  def get_partition_key(self):\n    ...\n  def get_function_name(self):\n    ...\n  def get_function_tenant(self):\n    ...\n  def get_function_namespace(self):\n    ...\n  def get_function_id(self):\n    ...\n  def get_instance_id(self):\n    ...\n  def get_function_version(self):\n    ...\n  def get_logger(self):\n    ...\n  def get_user_config_value(self, key):\n    ...\n  def get_user_config_map(self):\n    ...\n  def record_metric(self, metric_name, metric_value):\n    ...\n  def get_input_topics(self):\n    ...\n  def get_output_topic(self):\n    ...\n  def get_output_serde_class_name(self):\n    ...\n  def publish(self, topic_name, message, serde_class_name="serde.IdentitySerDe",\n              properties=None, compression_type=None, callback=None, message_conf=None):\n    ...\n  def ack(self, msgid, topic):\n    ...\n  def get_and_reset_metrics(self):\n    ...\n  def reset_metrics(self):\n    ...\n  def get_metrics(self):\n    ...\n  def incr_counter(self, key, amount):\n    ...\n  def get_counter(self, key):\n    ...\n  def del_counter(self, key):\n    ...\n  def put_state(self, key, value):\n    ...\n  def get_state(self, key):\n    ...\n\n'))),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\nfunc (c *FunctionContext) GetInstanceID() int {\n    return c.instanceConf.instanceID\n}\n\nfunc (c *FunctionContext) GetInputTopics() []string {\n    return c.inputTopics\n}\n\nfunc (c *FunctionContext) GetOutputTopic() string {\n    return c.instanceConf.funcDetails.GetSink().Topic\n}\n\nfunc (c *FunctionContext) GetFuncTenant() string {\n    return c.instanceConf.funcDetails.Tenant\n}\n\nfunc (c *FunctionContext) GetFuncName() string {\n    return c.instanceConf.funcDetails.Name\n}\n\nfunc (c *FunctionContext) GetFuncNamespace() string {\n    return c.instanceConf.funcDetails.Namespace\n}\n\nfunc (c *FunctionContext) GetFuncID() string {\n    return c.instanceConf.funcID\n}\n\nfunc (c *FunctionContext) GetFuncVersion() string {\n    return c.instanceConf.funcVersion\n}\n\nfunc (c *FunctionContext) GetUserConfValue(key string) interface{} {\n    return c.userConfigs[key]\n}\n\nfunc (c *FunctionContext) GetUserConfMap() map[string]interface{} {\n    return c.userConfigs\n}\n\n")),(0,o.kt)("p",null,"The following example uses several methods available via the ",(0,o.kt)("inlineCode",{parentName:"p"},"Context")," object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'\nimport (\n    "context"\n    "fmt"\n\n    "github.com/apache/pulsar/pulsar-function-go/pf"\n)\n\nfunc contextFunc(ctx context.Context) {\n    if fc, ok := pf.FromContext(ctx); ok {\n        fmt.Printf("function ID is:%s, ", fc.GetFuncID())\n        fmt.Printf("function version is:%s\\n", fc.GetFuncVersion())\n    }\n}\n\n')),(0,o.kt)("p",null,"For complete code, see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/blob/77cf09eafa4f1626a53a1fe2e65dd25f377c1127/pulsar-function-go/examples/contextFunc/contextFunc.go#L29-L34"},"here"),"."))),(0,o.kt)("h3",{id:"user-config"},"User config"),(0,o.kt)("p",null,"When you run or update Pulsar Functions created using SDK, you can pass arbitrary key/values to them with the command line with the ",(0,o.kt)("inlineCode",{parentName:"p"},"--user-config")," flag. Key/values must be specified as JSON. The following function creation command passes a user configured key/value to a function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'\n$ bin/pulsar-admin functions create \\\n  --name word-filter \\\n  # Other function configs\n  --user-config \'{"forbidden-word":"rosebud"}\'\n\n')),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"The Java SDK ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object enables you to access key/value pairs provided to Pulsar Functions via the command line (as JSON). The following example passes a key/value pair."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'\n$ bin/pulsar-admin functions create \\\n  # Other function configs\n  --user-config \'{"word-of-the-day":"verdure"}\'\n\n')),(0,o.kt)("p",null,"To access that value in a Java function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\nimport org.slf4j.Logger;\n\nimport java.util.Optional;\n\npublic class UserConfigFunction implements Function<String, Void> {\n    @Override\n    public void apply(String input, Context context) {\n        Logger LOG = context.getLogger();\n        Optional<String> wotd = context.getUserConfigValue("word-of-the-day");\n        if (wotd.isPresent()) {\n            LOG.info("The word of the day is {}", wotd);\n        } else {\n            LOG.warn("No word of the day provided");\n        }\n        return null;\n    }\n}\n\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"UserConfigFunction")," function will log the string ",(0,o.kt)("inlineCode",{parentName:"p"},'"The word of the day is verdure"')," every time the function is invoked (which means every time a message arrives). The ",(0,o.kt)("inlineCode",{parentName:"p"},"word-of-the-day")," user config will be changed only when the function is updated with a new config value via the command line."),(0,o.kt)("p",null,"You can also access the entire user config map or set a default value in case no value is present:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\n// Get the whole config map\nMap<String, String> allConfigs = context.getUserConfigMap();\n\n// Get value or resort to default\nString wotd = context.getUserConfigValueOrDefault("word-of-the-day", "perspicacious");\n\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"For all key/value pairs passed to Java functions, both the key ",(0,o.kt)("em",{parentName:"p"},"and")," the value are ",(0,o.kt)("inlineCode",{parentName:"p"},"String"),". To set the value to be a different type, you need to deserialize from the ",(0,o.kt)("inlineCode",{parentName:"p"},"String")," type."))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"In Python function, you can access the configuration value like this."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\nfrom pulsar import Function\n\nclass WordFilter(Function):\n    def process(self, context, input):\n        forbidden_word = context.user_config()["forbidden-word"]\n\n        # Don\'t publish the message if it contains the user-supplied\n        # forbidden word\n        if forbidden_word in input:\n            pass\n        # Otherwise publish the message\n        else:\n            return input\n\n')),(0,o.kt)("p",null,"The Python SDK ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object enables you to access key/value pairs provided to Pulsar Functions via the command line (as JSON). The following example passes a key/value pair."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'\n$ bin/pulsar-admin functions create \\\n  # Other function configs \\\n  --user-config \'{"word-of-the-day":"verdure"}\'\n\n')),(0,o.kt)("p",null,"To access that value in a Python function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import Function\n\nclass UserConfigFunction(Function):\n    def process(self, input, context):\n        logger = context.get_logger()\n        wotd = context.get_user_config_value('word-of-the-day')\n        if wotd is None:\n            logger.warn('No word of the day provided')\n        else:\n            logger.info(\"The word of the day is {0}\".format(wotd))\n\n"))),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently, the feature is not available in Go."))),(0,o.kt)("h3",{id:"logger"},"Logger"),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"Pulsar Functions that use the Java SDK have access to an ",(0,o.kt)("a",{parentName:"p",href:"https://www.slf4j.org/"},"SLF4j")," ",(0,o.kt)("a",{parentName:"p",href:"https://www.slf4j.org/api/org/apache/log4j/Logger.html"},(0,o.kt)("inlineCode",{parentName:"a"},"Logger"))," object that can be used to produce logs at the chosen log level. The following example logs either a ",(0,o.kt)("inlineCode",{parentName:"p"},"WARNING"),"- or ",(0,o.kt)("inlineCode",{parentName:"p"},"INFO"),"-level log based on whether the incoming string contains the word ",(0,o.kt)("inlineCode",{parentName:"p"},"danger"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\nimport org.slf4j.Logger;\n\npublic class LoggingFunction implements Function<String, Void> {\n    @Override\n    public void apply(String input, Context context) {\n        Logger LOG = context.getLogger();\n        String messageId = new String(context.getMessageId());\n\n        if (input.contains("danger")) {\n            LOG.warn("A warning was received in message {}", messageId);\n        } else {\n            LOG.info("Message {} received\\nContent: {}", messageId, input);\n        }\n\n        return null;\n    }\n}\n\n')),(0,o.kt)("p",null,"If you want your function to produce logs, you need to specify a log topic when creating or running the function. The following is an example."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin functions create \\\n  --jar my-functions.jar \\\n  --classname my.package.LoggingFunction \\\n  --log-topic persistent://public/default/logging-function-logs \\\n  # Other function configs\n\n")),(0,o.kt)("p",null,"All logs produced by ",(0,o.kt)("inlineCode",{parentName:"p"},"LoggingFunction")," above can be accessed via the ",(0,o.kt)("inlineCode",{parentName:"p"},"persistent://public/default/logging-function-logs")," topic.")),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"Pulsar Functions that use the Python SDK have access to a logging object that can be used to produce logs at the chosen log level. The following example function that logs either a ",(0,o.kt)("inlineCode",{parentName:"p"},"WARNING"),"- or ",(0,o.kt)("inlineCode",{parentName:"p"},"INFO"),"-level log based on whether the incoming string contains the word ",(0,o.kt)("inlineCode",{parentName:"p"},"danger"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\nfrom pulsar import Function\n\nclass LoggingFunction(Function):\n    def process(self, input, context):\n        logger = context.get_logger()\n        msg_id = context.get_message_id()\n        if \'danger\' in input:\n            logger.warn("A warning was received in message {0}".format(context.get_message_id()))\n        else:\n            logger.info("Message {0} received\\nContent: {1}".format(msg_id, input))\n\n')),(0,o.kt)("p",null,"If you want your function to produce logs on a Pulsar topic, you need to specify a ",(0,o.kt)("strong",{parentName:"p"},"log topic")," when creating or running the function. The following is an example."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin functions create \\\n  --py logging_function.py \\\n  --classname logging_function.LoggingFunction \\\n  --log-topic logging-function-logs \\\n  # Other function configs\n\n")),(0,o.kt)("p",null,"All logs produced by ",(0,o.kt)("inlineCode",{parentName:"p"},"LoggingFunction")," above can be accessed via the ",(0,o.kt)("inlineCode",{parentName:"p"},"logging-function-logs")," topic.")),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("p",null,"The following Go Function example shows different log levels based on the function input."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'\nimport (\n    "context"\n\n    "github.com/apache/pulsar/pulsar-function-go/pf"\n\n    log "github.com/apache/pulsar/pulsar-function-go/logutil"\n)\n\nfunc loggerFunc(ctx context.Context, input []byte) {\n    if len(input) <= 100 {\n        log.Infof("This input has a length of: %d", len(input))\n    } else {\n        log.Warnf("This input is getting too long! It has {%d} characters", len(input))\n    }\n}\n\nfunc main() {\n    pf.Start(loggerFunc)\n}\n\n')),(0,o.kt)("p",null,"When you use ",(0,o.kt)("inlineCode",{parentName:"p"},"logTopic")," related functionalities in Go Function, import ",(0,o.kt)("inlineCode",{parentName:"p"},"github.com/apache/pulsar/pulsar-function-go/logutil"),", and you do not have to use the ",(0,o.kt)("inlineCode",{parentName:"p"},"getLogger()")," context object."))),(0,o.kt)("h2",{id:"metrics"},"Metrics"),(0,o.kt)("p",null,"Pulsar Functions can publish arbitrary metrics to the metrics interface which can be queried. "),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"If a Pulsar Function uses the language-native interface for Java or Python, that function is not able to publish metrics and stats to Pulsar.")),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"You can record metrics using the ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object on a per-key basis. For example, you can set a metric for the ",(0,o.kt)("inlineCode",{parentName:"p"},"process-count")," key and a different metric for the ",(0,o.kt)("inlineCode",{parentName:"p"},"elevens-count")," key every time the function processes a message. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\n\npublic class MetricRecorderFunction implements Function<Integer, Void> {\n    @Override\n    public void apply(Integer input, Context context) {\n        // Records the metric 1 every time a message arrives\n        context.recordMetric("hit-count", 1);\n\n        // Records the metric only if the arriving number equals 11\n        if (input == 11) {\n            context.recordMetric("elevens-count", 1);\n        }\n\n        return null;\n    }\n}\n\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"For instructions on reading and using metrics, see the ",(0,o.kt)("a",{parentName:"p",href:"deploy-monitoring"},"Monitoring")," guide."))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"You can record metrics using the ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object on a per-key basis. For example, you can set a metric for the ",(0,o.kt)("inlineCode",{parentName:"p"},"process-count")," key and a different metric for the ",(0,o.kt)("inlineCode",{parentName:"p"},"elevens-count")," key every time the function processes a message. The following is an example."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import Function\n\nclass MetricRecorderFunction(Function):\n    def process(self, input, context):\n        context.record_metric('hit-count', 1)\n\n        if input == 11:\n            context.record_metric('elevens-count', 1)\n\n"))),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently, the feature is not available in Go."))),(0,o.kt)("h3",{id:"access-metrics"},"Access metrics"),(0,o.kt)("p",null,"To access metrics created by Pulsar Functions, refer to ",(0,o.kt)("a",{parentName:"p",href:"deploy-monitoring"},"Monitoring")," in Pulsar. "),(0,o.kt)("h2",{id:"security"},"Security"),(0,o.kt)("p",null,"If you want to enable security on Pulsar Functions, first you should enable security on ",(0,o.kt)("a",{parentName:"p",href:"functions-worker"},"Functions Workers"),". For more details, refer to ",(0,o.kt)("a",{parentName:"p",href:"/docs/2.6.0/functions-worker#security-settings"},"Security settings"),"."),(0,o.kt)("p",null,"Pulsar Functions can support the following providers:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ClearTextSecretsProvider"),(0,o.kt)("li",{parentName:"ul"},"EnvironmentBasedSecretsProvider")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Pulsar Function supports ClearTextSecretsProvider by default.")),(0,o.kt)("p",null,"At the same time, Pulsar Functions provides two interfaces, ",(0,o.kt)("strong",{parentName:"p"},"SecretsProvider")," and ",(0,o.kt)("strong",{parentName:"p"},"SecretsProviderConfigurator"),", allowing users to customize secret provider."),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"Go",value:"Go"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"You can get secret provider using the ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object. The following is an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\nimport org.slf4j.Logger;\n\npublic class GetSecretProviderFunction implements Function<String, Void> {\n\n    @Override\n    public Void process(String input, Context context) throws Exception {\n        Logger LOG = context.getLogger();\n        String secretProvider = context.getSecret(input);\n\n        if (!secretProvider.isEmpty()) {\n            LOG.info("The secret provider is {}", secretProvider);\n        } else {\n            LOG.warn("No secret provider");\n        }\n\n        return null;\n    }\n}\n\n'))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"You can get secret provider using the ",(0,o.kt)("a",{parentName:"p",href:"#context"},(0,o.kt)("inlineCode",{parentName:"a"},"Context"))," object. The following is an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import Function\n\nclass GetSecretProviderFunction(Function):\n    def process(self, input, context):\n        logger = context.get_logger()\n        secret_provider = context.get_secret(input)\n        if secret_provider is None:\n            logger.warn('No secret provider')\n        else:\n            logger.info(\"The secret provider is {0}\".format(secret_provider))\n\n"))),(0,o.kt)(i.Z,{value:"Go",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently, the feature is not available in Go."))),(0,o.kt)("h2",{id:"state-storage"},"State storage"),(0,o.kt)("p",null,"Pulsar Functions use ",(0,o.kt)("a",{parentName:"p",href:"https://bookkeeper.apache.org"},"Apache BookKeeper")," as a state storage interface. Pulsar installation, including the local standalone installation, includes deployment of BookKeeper bookies."),(0,o.kt)("p",null,"Since Pulsar 2.1.0 release, Pulsar integrates with Apache BookKeeper ",(0,o.kt)("a",{parentName:"p",href:"https://docs.google.com/document/d/155xAwWv5IdOitHh1NVMEwCMGgB28M3FyMiQSxEpjE-Y/edit#heading=h.56rbh52koe3f"},"table service")," to store the ",(0,o.kt)("inlineCode",{parentName:"p"},"State")," for functions. For example, a ",(0,o.kt)("inlineCode",{parentName:"p"},"WordCount")," function can store its ",(0,o.kt)("inlineCode",{parentName:"p"},"counters")," state into BookKeeper table service via Pulsar Functions State API."),(0,o.kt)("p",null,"States are key-value pairs, where the key is a string and the value is arbitrary binary data - counters are stored as 64-bit big-endian binary values. Keys are scoped to an individual Pulsar Function, and shared between instances of that function."),(0,o.kt)("p",null,"You can access states within Pulsar Java Functions using the ",(0,o.kt)("inlineCode",{parentName:"p"},"putState"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"putStateAsync"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"getState"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"getStateAsync"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounter"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounterAsync"),",  ",(0,o.kt)("inlineCode",{parentName:"p"},"getCounter"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"getCounterAsync")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"deleteState")," calls on the context object. You can access states within Pulsar Python Functions using the ",(0,o.kt)("inlineCode",{parentName:"p"},"putState"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"getState"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounter"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"getCounter")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"deleteState")," calls on the context object. You can also manage states using the ",(0,o.kt)("a",{parentName:"p",href:"#query-state"},"querystate")," and ",(0,o.kt)("a",{parentName:"p",href:"#putstate"},"putstate")," options to ",(0,o.kt)("inlineCode",{parentName:"p"},"pulsar-admin functions"),"."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"State storage is not available in Go.")),(0,o.kt)("h3",{id:"api"},"API"),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently Pulsar Functions expose the following APIs for mutating and accessing State. These APIs are available in the ",(0,o.kt)("a",{parentName:"p",href:"functions-develop.md#context"},"Context")," object when you are using Java SDK functions."),(0,o.kt)("h4",{id:"incrcounter"},"incrCounter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Increment the builtin distributed counter referred by key\n     * @param key The name of the key\n     * @param amount The amount to be incremented\n     */\n    void incrCounter(String key, long amount);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounter")," to change the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," by the given ",(0,o.kt)("inlineCode",{parentName:"p"},"amount"),"."),(0,o.kt)("h4",{id:"incrcounterasync"},"incrCounterAsync"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n     /**\n     * Increment the builtin distributed counter referred by key\n     * but dont wait for the completion of the increment operation\n     *\n     * @param key The name of the key\n     * @param amount The amount to be incremented\n     */\n    CompletableFuture<Void> incrCounterAsync(String key, long amount);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounterAsync")," to asynchronously change the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," by the given ",(0,o.kt)("inlineCode",{parentName:"p"},"amount"),"."),(0,o.kt)("h4",{id:"getcounter"},"getCounter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Retrieve the counter value for the key.\n     *\n     * @param key name of the key\n     * @return the amount of the counter value for this key\n     */\n    long getCounter(String key);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"getCounter")," to retrieve the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," mutated by ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounter"),"."),(0,o.kt)("p",null,"Except the ",(0,o.kt)("inlineCode",{parentName:"p"},"counter")," API, Pulsar also exposes a general key/value API for functions to store\ngeneral key/value state."),(0,o.kt)("h4",{id:"getcounterasync"},"getCounterAsync"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n     /**\n     * Retrieve the counter value for the key, but don't wait\n     * for the operation to be completed\n     *\n     * @param key name of the key\n     * @return the amount of the counter value for this key\n     */\n    CompletableFuture<Long> getCounterAsync(String key);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"getCounterAsync")," to asynchronously retrieve the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," mutated by ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounterAsync"),"."),(0,o.kt)("h4",{id:"putstate"},"putState"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Update the state value for the key.\n     *\n     * @param key name of the key\n     * @param value state value of the key\n     */\n    void putState(String key, ByteBuffer value);\n\n")),(0,o.kt)("h4",{id:"putstateasync"},"putStateAsync"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Update the state value for the key, but don't wait for the operation to be completed\n     *\n     * @param key name of the key\n     * @param value state value of the key\n     */\n    CompletableFuture<Void> putStateAsync(String key, ByteBuffer value);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"putStateAsync")," to asynchronously update the state of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key"),"."),(0,o.kt)("h4",{id:"getstate"},"getState"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Retrieve the state value for the key.\n     *\n     * @param key name of the key\n     * @return the state value for the key.\n     */\n    ByteBuffer getState(String key);\n\n")),(0,o.kt)("h4",{id:"getstateasync"},"getStateAsync"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Retrieve the state value for the key, but don't wait for the operation to be completed\n     *\n     * @param key name of the key\n     * @return the state value for the key.\n     */\n    CompletableFuture<ByteBuffer> getStateAsync(String key);\n\n")),(0,o.kt)("p",null,"The application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"getStateAsync")," to asynchronously retrieve the state of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key"),"."),(0,o.kt)("h4",{id:"deletestate"},"deleteState"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\n    /**\n     * Delete the state value for the key.\n     *\n     * @param key   name of the key\n     */\n\n")),(0,o.kt)("p",null,"Counters and binary values share the same keyspace, so this deletes either type.")),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("p",null,"Currently Pulsar Functions expose the following APIs for mutating and accessing State. These APIs are available in the ",(0,o.kt)("a",{parentName:"p",href:"#context"},"Context")," object when you are using Python SDK functions."),(0,o.kt)("h4",{id:"incr_counter"},"incr_counter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\n  def incr_counter(self, key, amount):\n    ""incr the counter of a given key in the managed state""\n\n')),(0,o.kt)("p",null,"Application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"incr_counter")," to change the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," by the given ",(0,o.kt)("inlineCode",{parentName:"p"},"amount"),".\nIf the ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," does not exist, a new key is created."),(0,o.kt)("h4",{id:"get_counter"},"get_counter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\n  def get_counter(self, key):\n    """get the counter of a given key in the managed state"""\n\n')),(0,o.kt)("p",null,"Application can use ",(0,o.kt)("inlineCode",{parentName:"p"},"get_counter")," to retrieve the counter of a given ",(0,o.kt)("inlineCode",{parentName:"p"},"key")," mutated by ",(0,o.kt)("inlineCode",{parentName:"p"},"incrCounter"),"."),(0,o.kt)("p",null,"Except the ",(0,o.kt)("inlineCode",{parentName:"p"},"counter")," API, Pulsar also exposes a general key/value API for functions to store\ngeneral key/value state."),(0,o.kt)("h4",{id:"put_state"},"put_state"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\n  def put_state(self, key, value):\n    """update the value of a given key in the managed state"""\n\n')),(0,o.kt)("p",null,"The key is a string, and the value is arbitrary binary data."),(0,o.kt)("h4",{id:"get_state"},"get_state"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\n  def get_state(self, key):\n    """get the value of a given key in the managed state"""\n\n')),(0,o.kt)("h4",{id:"del_counter"},"del_counter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'\n  def del_counter(self, key):\n    """delete the counter of a given key in the managed state"""\n\n')),(0,o.kt)("p",null,"Counters and binary values share the same keyspace, so this deletes either type."))),(0,o.kt)("h3",{id:"query-state"},"Query State"),(0,o.kt)("p",null,"A Pulsar Function can use the ",(0,o.kt)("a",{parentName:"p",href:"#api"},"State API")," for storing state into Pulsar's state storage\nand retrieving state back from Pulsar's state storage. Additionally Pulsar also provides\nCLI commands for querying its state."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"\n$ bin/pulsar-admin functions querystate \\\n    --tenant <tenant> \\\n    --namespace <namespace> \\\n    --name <function-name> \\\n    --state-storage-url <bookkeeper-service-url> \\\n    --key <state-key> \\\n    [---watch]\n\n")),(0,o.kt)("p",null,"If ",(0,o.kt)("inlineCode",{parentName:"p"},"--watch")," is specified, the CLI will watch the value of the provided ",(0,o.kt)("inlineCode",{parentName:"p"},"state-key"),"."),(0,o.kt)("h3",{id:"example-1"},"Example"),(0,o.kt)(r.Z,{defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"}],mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"Java",mdxType:"TabItem"},(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/pulsar/tree/master//pulsar-functions/java-examples/src/main/java/org/apache/pulsar/functions/api/examples/WordCountFunction.java"},"WordCountFunction")," is a very good example\ndemonstrating on how Application can easily store ",(0,o.kt)("inlineCode",{parentName:"p"},"state")," in Pulsar Functions."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.functions.api.Context;\nimport org.apache.pulsar.functions.api.Function;\n\nimport java.util.Arrays;\n\npublic class WordCountFunction implements Function<String, Void> {\n    @Override\n    public Void process(String input, Context context) throws Exception {\n        Arrays.asList(input.split("\\\\.")).forEach(word -> context.incrCounter(word, 1));\n        return null;\n    }\n}\n\n')),(0,o.kt)("p",null,"The logic of this ",(0,o.kt)("inlineCode",{parentName:"p"},"WordCount")," function is pretty simple and straightforward:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The function first splits the received ",(0,o.kt)("inlineCode",{parentName:"li"},"String")," into multiple words using regex ",(0,o.kt)("inlineCode",{parentName:"li"},"\\\\."),"."),(0,o.kt)("li",{parentName:"ol"},"For each ",(0,o.kt)("inlineCode",{parentName:"li"},"word"),", the function increments the corresponding ",(0,o.kt)("inlineCode",{parentName:"li"},"counter")," by 1 (via ",(0,o.kt)("inlineCode",{parentName:"li"},"incrCounter(key, amount)"),")."))),(0,o.kt)(i.Z,{value:"Python",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\nfrom pulsar import Function\n\nclass WordCount(Function):\n    def process(self, item, context):\n        for word in item.split():\n            context.incr_counter(word, 1)\n\n")),(0,o.kt)("p",null,"The logic of this ",(0,o.kt)("inlineCode",{parentName:"p"},"WordCount")," function is pretty simple and straightforward:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The function first splits the received string into multiple words on space."),(0,o.kt)("li",{parentName:"ol"},"For each ",(0,o.kt)("inlineCode",{parentName:"li"},"word"),", the function increments the corresponding ",(0,o.kt)("inlineCode",{parentName:"li"},"counter")," by 1 (via ",(0,o.kt)("inlineCode",{parentName:"li"},"incr_counter(key, amount)"),").")))))}d.isMDXComponent=!0}}]);