"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[71285],{47929:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"txn-use","title":"How to use transactions?","description":"Transaction API","source":"@site/versioned_docs/version-2.11.x/txn-use.md","sourceDirName":".","slug":"/txn-use","permalink":"/docs/2.11.x/txn-use","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-2.11.x/txn-use.md","tags":[],"version":"2.11.x","frontMatter":{"id":"txn-use","title":"How to use transactions?","sidebar_label":"How to use transactions?"},"sidebar":"docsSidebar","previous":{"title":"How transactions work?","permalink":"/docs/2.11.x/txn-how"},"next":{"title":"How to monitor transactions?","permalink":"/docs/2.11.x/txn-monitor"}}');var a=t(74848),i=t(28453);const o={id:"txn-use",title:"How to use transactions?",sidebar_label:"How to use transactions?"},r=void 0,c={},l=[{value:"Transaction API",id:"transaction-api",level:2},{value:"Quick start",id:"quick-start",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"transaction-api",children:"Transaction API"}),"\n",(0,a.jsxs)(n.p,{children:["The transaction feature is primarily a server-side and protocol-level feature. You can use the transaction feature via the ",(0,a.jsx)(n.a,{href:"https://pulsar.apache.org/api/admin/2.11.x/",children:"transaction API"}),", which is available in ",(0,a.jsx)(n.strong,{children:"Pulsar 2.8.0 or later"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["To use the transaction API, you do not need any additional settings in the Pulsar client. ",(0,a.jsx)(n.strong,{children:"By default"}),", transactions are ",(0,a.jsx)(n.strong,{children:"disabled"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Currently, transaction API is only available for ",(0,a.jsx)(n.strong,{children:"Java"})," clients. Support for other language clients will be added in future releases."]}),"\n",(0,a.jsx)(n.h2,{id:"quick-start",children:"Quick start"}),"\n",(0,a.jsx)(n.p,{children:"This section provides an example of how to use the transaction API to send and receive messages in a Java client."}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Start Pulsar 2.8.0 or later."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Enable transaction."}),"\n",(0,a.jsxs)(n.p,{children:["Change the configuration in the ",(0,a.jsx)(n.code,{children:"broker.conf"})," or ",(0,a.jsx)(n.code,{children:"standalone.conf"})," file."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-conf",children:"//mandatory configuration, used to enable transaction coordinator\ntransactionCoordinatorEnabled=true\n\n//mandtory configuration, used to create systemTopic used for transaction buffer snapshot\nsystemTopicEnabled=true\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["If you want to acknowledge batch messages in transactions, set ",(0,a.jsx)(n.code,{children:"acknowledgmentAtBatchIndexLevelEnabled"})," to ",(0,a.jsx)(n.code,{children:"true"})," in the ",(0,a.jsx)(n.code,{children:"broker.conf"})," or ",(0,a.jsx)(n.code,{children:"standalone.conf"})," file."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-conf",children:"acknowledgmentAtBatchIndexLevelEnabled=true\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["If you want to guarantee exactly-once semantics, you need to enable ",(0,a.jsx)(n.a,{href:"/docs/2.11.x/cookbooks-deduplication",children:"message deduplication"}),".\nYou can enable message deduplication at the broker level, the namespace level, or the topic level according to your needs."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Initialize transaction coordinator metadata."}),"\n",(0,a.jsx)(n.p,{children:"The transaction coordinator can leverage the advantages of partitioned topics (such as load balance)."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Input"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"bin/pulsar initialize-transaction-coordinator-metadata -cs 127.0.0.1:2181 -c standalone\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Output"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"Transaction coordinator metadata setup success\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Initialize a Pulsar client."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'PulsarClient client = PulsarClient.builder()\n   .serviceUrl("pulsar://localhost:6650")\n   .enableTransaction(true)\n   .build();\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Now you can start using the transaction API to send and receive messages. Below is an example of a ",(0,a.jsx)(n.code,{children:"consume-process-produce"})," application written in Java."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(91163).A+"",width:"1844",height:"1100"})}),"\n",(0,a.jsx)(n.p,{children:"Let\u2019s walk through this example step by step."}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Step"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"1. Start a transaction."}),(0,a.jsx)(n.td,{children:"The application opens a new transaction by calling PulsarClient.newTransaction. It specifics the transaction timeout as 1 minute. If the transaction is not committed within 1 minute, the transaction is automatically aborted."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"2. Receive messages from topics."}),(0,a.jsx)(n.td,{children:"The application creates two normal consumers to receive messages from topic input-topic-1 and input-topic-2 respectively."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"3. Publish messages to topics with the transaction."}),(0,a.jsxs)(n.td,{children:["The application creates two producers to produce the resulting messages to the output topic ",(0,a.jsx)(n.em,{children:"output-topic-1"})," and output-topic-2 respectively. The application applies the processing logic and generates two output messages. The application sends those two output messages as part of the transaction opened in the first step via ",(0,a.jsx)(n.code,{children:"Producer.newMessage(Transaction)"}),"."]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"4. Acknowledge the messages with the transaction."}),(0,a.jsx)(n.td,{children:"In the same transaction, the application acknowledges the two input messages."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"5. Commit the transaction."}),(0,a.jsxs)(n.td,{children:["The application commits the transaction by calling ",(0,a.jsx)(n.code,{children:"Transaction.commit()"})," on the open transaction. The commit operation ensures the two input messages are marked as acknowledged and the two output messages are written successfully to the output topics."]})]})]})]}),"\n",(0,a.jsx)(n.p,{children:"[1] Example of enabling batch messages ack in transactions in the consumer builder."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'Consumer<byte[]> consumer = pulsarClient\n    .newConsumer()\n    .topic(transferTopic)\n    .subscriptionName("transaction-sub")\n    .subscriptionInitialPosition(SubscriptionInitialPosition.Earliest)\n    .subscriptionType(SubscriptionType.Shared)\n    .enableBatchIndexAcknowledgment(true) // enable batch index acknowledgment\n    .subscribe();\n'})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},91163:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/txn-9-65da8c1f05f7575701ca8614637c112a.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var s=t(96540);const a={},i=s.createContext(a);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);