"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[13639],{56134:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"tiered-storage-filesystem","title":"Use filesystem offloader with Pulsar","description":"This chapter guides you through every step of installing and configuring the filesystem offloader and using it with Pulsar.","source":"@site/versioned_docs/version-2.9.x/tiered-storage-filesystem.md","sourceDirName":".","slug":"/tiered-storage-filesystem","permalink":"/docs/2.9.x/tiered-storage-filesystem","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-2.9.x/tiered-storage-filesystem.md","tags":[],"version":"2.9.x","frontMatter":{"id":"tiered-storage-filesystem","title":"Use filesystem offloader with Pulsar","sidebar_label":"Filesystem offloader","original_id":"tiered-storage-filesystem"},"sidebar":"docsSidebar","previous":{"title":"GCS offloader","permalink":"/docs/2.9.x/tiered-storage-gcs"},"next":{"title":"Azure BlobStore offloader","permalink":"/docs/2.9.x/tiered-storage-azure"}}');var i=s(74848),l=s(28453);const o={id:"tiered-storage-filesystem",title:"Use filesystem offloader with Pulsar",sidebar_label:"Filesystem offloader",original_id:"tiered-storage-filesystem"},a=void 0,t={},d=[{value:"Installation",id:"installation",level:2},{value:"Prerequisite",id:"prerequisite",level:3},{value:"Step",id:"step",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Configure filesystem offloader driver",id:"configure-filesystem-offloader-driver",level:3},{value:"Offloader driver (required)",id:"offloader-driver-required",level:4},{value:"Connection address (required)",id:"connection-address-required",level:4},{value:"Example",id:"example",level:5},{value:"Hadoop profile path (required)",id:"hadoop-profile-path-required",level:4},{value:"Example",id:"example-1",level:5},{value:"Configure filesystem offloader to run automatically",id:"configure-filesystem-offloader-to-run-automatically",level:3},{value:"Example",id:"example-2",level:4},{value:"Configure filesystem offloader to run manually",id:"configure-filesystem-offloader-to-run-manually",level:3},{value:"Example",id:"example-3",level:4},{value:"Tutorial",id:"tutorial",level:2}];function c(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This chapter guides you through every step of installing and configuring the filesystem offloader and using it with Pulsar."}),"\n",(0,i.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsx)(n.p,{children:"Follow the steps below to install the filesystem offloader."}),"\n",(0,i.jsx)(n.h3,{id:"prerequisite",children:"Prerequisite"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Pulsar: 2.4.2 or later versions"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Hadoop: 3.x.x"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step",children:"Step"}),"\n",(0,i.jsx)(n.p,{children:"This example uses Pulsar 2.5.1."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Download the Pulsar tarball using one of the following ways:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Download from the ",(0,i.jsx)(n.a,{href:"https://archive.apache.org/dist/pulsar/pulsar-2.5.1/apache-pulsar-2.5.1-bin.tar.gz",children:"Apache mirror"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Download from the Pulsar ",(0,i.jsx)(n.a,{href:"pathname:///download",children:"download page"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.a,{href:"https://www.gnu.org/software/wget",children:"wget"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"\nwget https://archive.apache.org/dist/pulsar/pulsar-2.5.1/apache-pulsar-2.5.1-bin.tar.gz\n\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Download and untar the Pulsar offloaders package."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\nwget https://downloads.apache.org/pulsar/pulsar-2.5.1/apache-pulsar-offloaders-2.5.1-bin.tar.gz\n\ntar xvfz apache-pulsar-offloaders-2.5.1-bin.tar.gz\n\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If you are running Pulsar in a bare metal cluster, make sure that ",(0,i.jsx)(n.code,{children:"offloaders"})," tarball is unzipped in every broker's Pulsar directory."]}),"\n",(0,i.jsxs)(n.li,{children:["If you are running Pulsar in Docker or deploying Pulsar using a Docker image (such as K8S and DCOS), you can use the ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar-all"})," image instead of the ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar"})," image. ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar-all"})," image has already bundled tiered storage offloaders."]}),"\n"]})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Copy the Pulsar offloaders as ",(0,i.jsx)(n.code,{children:"offloaders"})," in the Pulsar directory."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\nmv apache-pulsar-offloaders-2.5.1/offloaders apache-pulsar-2.5.1/offloaders\n\nls offloaders\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Output"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\ntiered-storage-file-system-2.5.1.nar\ntiered-storage-jcloud-2.5.1.nar\n\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If you are running Pulsar in a bare metal cluster, make sure that ",(0,i.jsx)(n.code,{children:"offloaders"})," tarball is unzipped in every broker's Pulsar directory."]}),"\n",(0,i.jsxs)(n.li,{children:["If you are running Pulsar in Docker or deploying Pulsar using a Docker image (such as K8s and DCOS), you can use the ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar-all"})," image instead of the ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar"})," image. ",(0,i.jsx)(n.code,{children:"apachepulsar/pulsar-all"})," image has already bundled tiered storage offloaders."]}),"\n"]})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Before offloading data from BookKeeper to filesystem, you need to configure some properties of the filesystem offloader driver."})}),"\n",(0,i.jsx)(n.p,{children:"Besides, you can also configure the filesystem offloader to run it automatically or trigger it manually."}),"\n",(0,i.jsx)(n.h3,{id:"configure-filesystem-offloader-driver",children:"Configure filesystem offloader driver"}),"\n",(0,i.jsxs)(n.p,{children:["You can configure filesystem offloader driver in the configuration file ",(0,i.jsx)(n.code,{children:"broker.conf"})," or ",(0,i.jsx)(n.code,{children:"standalone.conf"}),"."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Required"})," configurations are as below."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Required configuration"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Example value"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"managedLedgerOffloadDriver"})}),(0,i.jsx)(n.td,{children:"Offloader driver name, which is case-insensitive."}),(0,i.jsx)(n.td,{children:"filesystem"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"fileSystemURI"})}),(0,i.jsx)(n.td,{children:"Connection address"}),(0,i.jsx)(n.td,{children:"hdfs://127.0.0.1:9000"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"fileSystemProfilePath"})}),(0,i.jsx)(n.td,{children:"Hadoop profile path"}),(0,i.jsx)(n.td,{children:"conf/filesystem_offload_core_site.xml"})]})]})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Optional"})," configurations are as below."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Optional configuration"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Example value"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"managedLedgerMinLedgerRolloverTimeMinutes"})}),(0,i.jsxs)(n.td,{children:["Minimum time between ledger rollover for a topic",(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),(0,i.jsx)(n.strong,{children:"Note"}),": it is not recommended that you set this configuration in the production environment."]}),(0,i.jsx)(n.td,{children:"10"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"managedLedgerMaxEntriesPerLedger"})}),(0,i.jsxs)(n.td,{children:["Maximum number of entries to append to a ledger before triggering a rollover.",(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),(0,i.jsx)(n.strong,{children:"Note"}),": it is not recommended that you set this configuration in the production environment."]}),(0,i.jsx)(n.td,{children:"50000"})]})]})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"offloader-driver-required",children:"Offloader driver (required)"}),"\n",(0,i.jsx)(n.p,{children:"Offloader driver name, which is case-insensitive."}),"\n",(0,i.jsxs)(n.p,{children:["This example sets the offloader driver name as ",(0,i.jsx)(n.em,{children:"filesystem"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-conf",children:"\nmanagedLedgerOffloadDriver=filesystem\n\n"})}),"\n",(0,i.jsx)(n.h4,{id:"connection-address-required",children:"Connection address (required)"}),"\n",(0,i.jsx)(n.p,{children:"Connection address is the URI to access the default Hadoop distributed file system."}),"\n",(0,i.jsx)(n.h5,{id:"example",children:"Example"}),"\n",(0,i.jsxs)(n.p,{children:["This example sets the connection address as ",(0,i.jsx)(n.em,{children:"hdfs://127.0.0.1:9000"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-conf",children:"\nfileSystemURI=hdfs://127.0.0.1:9000\n\n"})}),"\n",(0,i.jsx)(n.h4,{id:"hadoop-profile-path-required",children:"Hadoop profile path (required)"}),"\n",(0,i.jsx)(n.p,{children:"The configuration file is stored in the Hadoop profile path. It contains various settings for Hadoop performance tuning."}),"\n",(0,i.jsx)(n.h5,{id:"example-1",children:"Example"}),"\n",(0,i.jsxs)(n.p,{children:["This example sets the Hadoop profile path as ",(0,i.jsx)(n.em,{children:"conf/filesystem_offload_core_site.xml"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-conf",children:"\nfileSystemProfilePath=conf/filesystem_offload_core_site.xml\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can set the following configurations in the ",(0,i.jsx)(n.em,{children:"filesystem_offload_core_site.xml"})," file."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\n<property>\n    <name>fs.defaultFS</name>\n    <value></value>\n</property>\n\n<property>\n    <name>hadoop.tmp.dir</name>\n    <value>pulsar</value>\n</property>\n\n<property>\n    <name>io.file.buffer.size</name>\n    <value>4096</value>\n</property>\n\n<property>\n    <name>io.seqfile.compress.blocksize</name>\n    <value>1000000</value>\n</property>\n<property>\n\n    <name>io.seqfile.compression.type</name>\n    <value>BLOCK</value>\n</property>\n\n<property>\n    <name>io.map.index.interval</name>\n    <value>128</value>\n</property>\n\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["For more information about the Hadoop HDFS, see ",(0,i.jsx)(n.a,{href:"https://hadoop.apache.org/docs/current/",children:"here"}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"configure-filesystem-offloader-to-run-automatically",children:"Configure filesystem offloader to run automatically"}),"\n",(0,i.jsx)(n.p,{children:"Namespace policy can be configured to offload data automatically once a threshold is reached. The threshold is based on the size of data that a topic has stored on a Pulsar cluster. Once the topic reaches the threshold, an offload operation is triggered automatically."}),"\n",(0,i.jsx)(n.table,{children:(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Threshold value"}),(0,i.jsx)(n.th,{children:"Action"})]})})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"0 | It triggers the offloading operation if the topic storage reaches its threshold.\n= 0|It causes a broker to offload data as soon as possible.\n< 0 |It disables automatic offloading operation."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Automatic offload runs when a new segment is added to a topic log. If you set the threshold on a namespace, but few messages are being produced to the topic, offloader does not work until the current segment is full."}),"\n",(0,i.jsx)(n.p,{children:"You can configure the threshold size using CLI tools, such as pulsar-admin."}),"\n",(0,i.jsx)(n.h4,{id:"example-2",children:"Example"}),"\n",(0,i.jsx)(n.p,{children:"This example sets the filesystem offloader threshold size to 10 MB using pulsar-admin."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\npulsar-admin namespaces set-offload-threshold --size 10M my-tenant/my-namespace\n\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["For more information about the ",(0,i.jsx)(n.code,{children:"pulsar-admin namespaces set-offload-threshold options"})," command, including flags, descriptions, default values, and shorthands, see ",(0,i.jsx)(n.a,{href:"/docs/2.9.x/reference-pulsar-admin#set-offload-threshold",children:"here"}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"configure-filesystem-offloader-to-run-manually",children:"Configure filesystem offloader to run manually"}),"\n",(0,i.jsx)(n.p,{children:"For individual topics, you can trigger filesystem offloader manually using one of the following methods:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Use REST endpoint."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Use CLI tools (such as pulsar-admin)."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"To trigger via CLI tools, you need to specify the maximum amount of data (threshold) that should be retained on a Pulsar cluster for a topic. If the size of the topic data on the Pulsar cluster exceeds this threshold, segments from the topic are offloaded to the filesystem until the threshold is no longer exceeded. Older segments are offloaded first."}),"\n",(0,i.jsx)(n.h4,{id:"example-3",children:"Example"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"This example triggers the filesystem offloader to run manually using pulsar-admin."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\npulsar-admin topics offload --size-threshold 10M persistent://my-tenant/my-namespace/topic1\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Output"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\nOffload triggered for persistent://my-tenant/my-namespace/topic1 for messages before 2:0:-1\n\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["For more information about the ",(0,i.jsx)(n.code,{children:"pulsar-admin topics offload options"})," command, including flags, descriptions, default values, and shorthands, see ",(0,i.jsx)(n.a,{href:"/docs/2.9.x/reference-pulsar-admin#offload",children:"here"}),"."]})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"This example checks filesystem offloader status using pulsar-admin."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\npulsar-admin topics offload-status persistent://my-tenant/my-namespace/topic1\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Output"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\nOffload is currently running\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To wait for the filesystem to complete the job, add the ",(0,i.jsx)(n.code,{children:"-w"})," flag."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\npulsar-admin topics offload-status -w persistent://my-tenant/my-namespace/topic1\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Output"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\nOffload was a success\n\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If there is an error in the offloading operation, the error is propagated to the ",(0,i.jsx)(n.code,{children:"pulsar-admin topics offload-status"})," command."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"\npulsar-admin topics offload-status persistent://my-tenant/my-namespace/topic1\n\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Output"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\nError in offload\nnull\n\nReason: Error offloading: org.apache.bookkeeper.mledger.ManagedLedgerException: java.util.concurrent.CompletionException: com.amazonaws.services.s3.model.AmazonS3Exception: Anonymous users cannot initiate multipart uploads.  Please authenticate. (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: 798758DE3F1776DF; S3 Extended Request ID: dhBFz/lZm1oiG/oBEepeNlhrtsDlzoOhocuYMpKihQGXe6EG8puRGOkK6UwqzVrMXTWBxxHcS+g=), S3 Extended Request ID: dhBFz/lZm1oiG/oBEepeNlhrtsDlzoOhocuYMpKihQGXe6EG8puRGOkK6UwqzVrMXTWBxxHcS+g=\n\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"`"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["For more information about the ",(0,i.jsx)(n.code,{children:"pulsar-admin topics offload-status options"})," command, including flags, descriptions, default values, and shorthands, see ",(0,i.jsx)(n.a,{href:"/docs/2.9.x/reference-pulsar-admin#offload-status",children:"here"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"tutorial",children:"Tutorial"}),"\n",(0,i.jsxs)(n.p,{children:["For the complete and step-by-step instructions on how to use the filesystem offloader with Pulsar, see ",(0,i.jsx)(n.a,{href:"https://hub.streamnative.io/offloaders/filesystem/2.5.1",children:"here"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var r=s(96540);const i={},l=r.createContext(i);function o(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);