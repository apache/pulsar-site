"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[42964],{91057:(e,o,c)=>{c.r(o),c.d(o,{assets:()=>r,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"cookbooks-compaction","title":"Topic compaction","description":"Pulsar\'s topic compaction feature enables you to create compacted topics in which older, \\"obscured\\" entries are pruned from the topic, allowing for faster reads through the topic\'s history (which messages are deemed obscured/outdated/irrelevant will depend on your use case).","source":"@site/versioned_docs/version-3.0.x/cookbooks-compaction.md","sourceDirName":".","slug":"/cookbooks-compaction","permalink":"/docs/3.0.x/cookbooks-compaction","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-3.0.x/cookbooks-compaction.md","tags":[],"version":"3.0.x","frontMatter":{"id":"cookbooks-compaction","title":"Topic compaction","sidebar_label":"Topic compaction"},"sidebar":"docsSidebar","previous":{"title":"Produce and consume messages","permalink":"/docs/3.0.x/tutorials-produce-consume"},"next":{"title":"Message deduplication ","permalink":"/docs/3.0.x/cookbooks-deduplication"}}');var s=c(74848),t=c(28453);const a={id:"cookbooks-compaction",title:"Topic compaction",sidebar_label:"Topic compaction"},i=void 0,r={},l=[{value:"When should I use compacted topics?",id:"when-should-i-use-compacted-topics",level:2},{value:"Configure compaction to run automatically",id:"configure-compaction-to-run-automatically",level:2},{value:"Trigger compaction manually",id:"trigger-compaction-manually",level:2},{value:"Configure consumers",id:"configure-consumers",level:2},{value:"Remove compaction from a topic",id:"remove-compaction-from-a-topic",level:2}];function d(e){const o={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(o.p,{children:["Pulsar's ",(0,s.jsx)(o.a,{href:"/docs/3.0.x/concepts-topic-compaction#topic-compaction-example-the-stock-ticker",children:"topic compaction"})," feature enables you to create ",(0,s.jsx)(o.strong,{children:"compacted"}),' topics in which older, "obscured" entries are pruned from the topic, allowing for faster reads through the topic\'s history (which messages are deemed obscured/outdated/irrelevant will depend on your use case).']}),"\n",(0,s.jsx)(o.p,{children:"To use compaction:"}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsxs)(o.li,{children:["You need to give messages keys, as topic compaction in Pulsar takes place on a ",(0,s.jsx)(o.em,{children:"per-key basis"})," (i.e. messages are compacted based on their key). For a stock ticker use case, the stock symbol---e.g. ",(0,s.jsx)(o.code,{children:"AAPL"})," or ",(0,s.jsx)(o.code,{children:"GOOG"}),"---could serve as the key (more on this ",(0,s.jsx)(o.a,{href:"#when-should-i-use-compacted-topics",children:"below"}),"). Messages without keys will be left alone by the compaction process."]}),"\n",(0,s.jsxs)(o.li,{children:["Compaction can be configured to run ",(0,s.jsx)(o.a,{href:"#configure-compaction-to-run-automatically",children:"automatically"}),", or you can manually ",(0,s.jsx)(o.a,{href:"#trigger-compaction-manually",children:"trigger"})," compaction using the Pulsar administrative API."]}),"\n",(0,s.jsxs)(o.li,{children:["Your consumers must be ",(0,s.jsx)(o.a,{href:"#configure-consumers",children:"configured"})," to read from compacted topics (Java consumers, for example, have a ",(0,s.jsx)(o.code,{children:"readCompacted"})," setting that must be set to ",(0,s.jsx)(o.code,{children:"true"}),"). If this configuration is not set, consumers will still be able to read from the non-compacted topic."]}),"\n"]}),"\n",(0,s.jsxs)(o.blockquote,{children:["\n",(0,s.jsx)(o.p,{children:"Compaction only works on messages that have keys (as in the stock ticker example the stock symbol serves as the key for each message). Keys can thus be thought of as the axis along which compaction is applied. Messages that don't have keys are simply ignored by compaction."}),"\n"]}),"\n",(0,s.jsx)(o.h2,{id:"when-should-i-use-compacted-topics",children:"When should I use compacted topics?"}),"\n",(0,s.jsxs)(o.p,{children:["The classic example of a topic that could benefit from compaction would be a stock ticker topic through which consumers can access up-to-date values for specific stocks. Imagine a scenario in which messages carrying stock value data use the stock symbol as the key (",(0,s.jsx)(o.code,{children:"GOOG"}),", ",(0,s.jsx)(o.code,{children:"AAPL"}),", ",(0,s.jsx)(o.code,{children:"TWTR"}),", etc.). Compacting this topic would give consumers on the topic two options:"]}),"\n",(0,s.jsxs)(o.ul,{children:["\n",(0,s.jsx)(o.li,{children:'They can read from the "original," non-compacted topic in case they need access to "historical" values, i.e. the entirety of the topic\'s messages.'}),"\n",(0,s.jsx)(o.li,{children:"They can read from the compacted topic if they only want to see the most up-to-date messages."}),"\n"]}),"\n",(0,s.jsxs)(o.p,{children:["Thus, if you're using a Pulsar topic called ",(0,s.jsx)(o.code,{children:"stock-values"}),", some consumers could have access to all messages in the topic (perhaps because they're performing some kind of number crunching of all values in the last hour) while the consumers used to power the real-time stock ticker only see the compacted topic (and thus aren't forced to process outdated messages). Which variant of the topic any given consumer pulls messages from is determined by the consumer's ",(0,s.jsx)(o.a,{href:"#configure-consumers",children:"configuration"}),"."]}),"\n",(0,s.jsxs)(o.blockquote,{children:["\n",(0,s.jsx)(o.p,{children:"One of the benefits of compaction in Pulsar is that you aren't forced to choose between compacted and non-compacted topics, as the compaction process leaves the original topic as-is and essentially adds an alternate topic. In other words, you can run compaction on a topic and consumers that need access to the non-compacted version of the topic will not be adversely affected."}),"\n"]}),"\n",(0,s.jsx)(o.h2,{id:"configure-compaction-to-run-automatically",children:"Configure compaction to run automatically"}),"\n",(0,s.jsx)(o.p,{children:"Compaction policy specifies how large the topic backlog can grow before compaction is triggered."}),"\n",(0,s.jsx)(o.p,{children:"Tenant administrators can configure a compaction policy at namespace or topic levels. Configuring the compaction policy at the namespace level applies to all topics within that namespace."}),"\n",(0,s.jsx)(o.p,{children:"For example, to trigger compaction in a namespace when the backlog reaches 100MB:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"bin/pulsar-admin namespaces set-compaction-threshold \\\n--threshold 100M my-tenant/my-namespace\n"})}),"\n",(0,s.jsx)(o.h2,{id:"trigger-compaction-manually",children:"Trigger compaction manually"}),"\n",(0,s.jsxs)(o.p,{children:["To run compaction on a topic, you need to use the ",(0,s.jsx)(o.a,{href:"pathname:///reference/#/3.0.x/pulsar-admin/topics?id=compact",children:(0,s.jsx)(o.code,{children:"topics compact"})})," command for the ",(0,s.jsx)(o.a,{href:"pathname:///reference/#/3.0.x/pulsar-admin/",children:(0,s.jsx)(o.code,{children:"pulsar-admin"})})," CLI tool. Here's an example:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"bin/pulsar-admin topics compact \\\npersistent://my-tenant/my-namespace/my-topic\n"})}),"\n",(0,s.jsxs)(o.p,{children:["The ",(0,s.jsx)(o.code,{children:"pulsar-admin"})," tool runs compaction via the Pulsar ",(0,s.jsx)(o.a,{href:"https://pulsar.apache.org/admin-rest-api#/",children:"REST"})," API. To run compaction in its own dedicated process, i.e. ",(0,s.jsx)(o.em,{children:"not"})," through the REST API, you can use the ",(0,s.jsx)(o.a,{href:"/docs/3.0.x/reference-cli-tools",children:(0,s.jsx)(o.code,{children:"pulsar compact-topic"})})," command. Here's an example:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"bin/pulsar compact-topic \\\n--topic persistent://my-tenant-namespace/my-topic\n"})}),"\n",(0,s.jsxs)(o.blockquote,{children:["\n",(0,s.jsxs)(o.p,{children:["Running compaction in its own process is recommended when you want to avoid interfering with the broker's performance. Broker performance should only be affected, however, when running compaction on topics with a large keyspace (i.e when there are many keys on the topic). The first phase of the compaction process keeps a copy of each key in the topic, which can create memory pressure as the number of keys grows. Using the ",(0,s.jsx)(o.code,{children:"pulsar-admin topics compact"})," command to run compaction through the REST API should present no issues in the overwhelming majority of cases; using ",(0,s.jsx)(o.code,{children:"pulsar compact-topic"})," should correspondingly be considered an edge case."]}),"\n"]}),"\n",(0,s.jsxs)(o.p,{children:["The ",(0,s.jsx)(o.code,{children:"pulsar compact-topic"})," command communicates with ",(0,s.jsx)(o.a,{href:"https://zookeeper.apache.org",children:"ZooKeeper"})," directly. To establish communication with ZooKeeper, though, the ",(0,s.jsx)(o.code,{children:"pulsar"})," CLI tool will need to have a valid ",(0,s.jsx)(o.a,{href:"/docs/3.0.x/reference-configuration#broker",children:"broker configuration"}),". You can either supply a proper configuration in ",(0,s.jsx)(o.code,{children:"conf/broker.conf"})," or specify a non-default location for the configuration:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-bash",children:"bin/pulsar compact-topic \\\n--broker-conf /path/to/broker.conf \\\n--topic persistent://my-tenant/my-namespace/my-topic\n\n# If the configuration is in conf/broker.conf\nbin/pulsar compact-topic \\\n--topic persistent://my-tenant/my-namespace/my-topic\n"})}),"\n",(0,s.jsx)(o.admonition,{type:"tip",children:(0,s.jsx)(o.p,{children:"The frequency to trigger topic compaction varies widely based on use cases. If you want a compacted topic to be extremely speedy on read, then you need to run compaction fairly frequently."})}),"\n",(0,s.jsx)(o.h2,{id:"configure-consumers",children:"Configure consumers"}),"\n",(0,s.jsx)(o.p,{children:"Pulsar consumers and readers need to be configured to read from compacted topics. The section below introduces how to enable compacted topic reads for Java clients."}),"\n",(0,s.jsxs)(o.p,{children:["To read from a compacted topic using a Java consumer, the ",(0,s.jsx)(o.code,{children:"readCompacted"})," parameter must be set to ",(0,s.jsx)(o.code,{children:"true"}),". Here's an example consumer for a compacted topic:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-java",children:'Consumer<byte[]> compactedTopicConsumer = client.newConsumer()\n        .topic("some-compacted-topic")\n        .readCompacted(true)\n        .subscribe();\n'})}),"\n",(0,s.jsxs)(o.p,{children:["As mentioned above, topic compaction in Pulsar works on a ",(0,s.jsx)(o.em,{children:"per-key basis"}),". That means that messages that you produce on compacted topics need to have keys (the content of the key will depend on your use case). Messages that don't have keys will be ignored by the compaction process. Here's an example Pulsar message with a key:"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-java",children:'import org.apache.pulsar.client.api.TypedMessageBuilder;\n\nTypedMessageBuilder<byte[]> msg = producer.newMessage()\n        .key("some-key")\n        .value(someByteArray);\n'})}),"\n",(0,s.jsx)(o.p,{children:"The example below shows a message with a key being produced on a compacted Pulsar topic:"}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-java",children:'import org.apache.pulsar.client.api.Producer;\nimport org.apache.pulsar.client.api.PulsarClient;\n\nPulsarClient client = PulsarClient.builder()\n        .serviceUrl("pulsar://localhost:6650")\n        .build();\n\nProducer<byte[]> compactedTopicProducer = client.newProducer()\n        .topic("some-compacted-topic")\n        .create();\n\ncompactedTopicProducer.newMessage()\n        .key("some-key")\n        .value(someByteArray)\n        .send();\n'})}),"\n",(0,s.jsx)(o.h2,{id:"remove-compaction-from-a-topic",children:"Remove compaction from a topic"}),"\n",(0,s.jsxs)(o.p,{children:["Since versions ",(0,s.jsx)(o.code,{children:"2.11.4"}),", ",(0,s.jsx)(o.code,{children:"3.0.3"}),", and ",(0,s.jsx)(o.code,{children:"3.1.0"})," (with ",(0,s.jsx)(o.a,{href:"https://github.com/apache/pulsar/pull/21745",children:"PR 21745"}),"), you can remove compaction by removing the ",(0,s.jsx)(o.code,{children:"__compaction"})," subscription."]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-shell",children:"bin/pulsar-admin topics unsubscribe {topic} -s __compaction\n"})}),"\n",(0,s.jsxs)(o.p,{children:["Before versions ",(0,s.jsx)(o.code,{children:"2.11.4"}),", ",(0,s.jsx)(o.code,{children:"3.0.3"}),", and ",(0,s.jsx)(o.code,{children:"3.1.0"}),", if you wanted to remove compaction from a topic, you needed access to the BookKeeper shell to remove the compaction data. The steps are:"]}),"\n",(0,s.jsxs)(o.ol,{children:["\n",(0,s.jsx)(o.li,{children:"Get the compacted ledgerId from the compactedLedger of stats-internal"}),"\n"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-shell",children:"bin/pulsar-admin topics stats-internal {topic}\n"})}),"\n",(0,s.jsxs)(o.ol,{start:"2",children:["\n",(0,s.jsx)(o.li,{children:"Delete the compacted ledger"}),"\n"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-shell",children:"bin/bookkeeper shell deleteledger {compacted_ledger}\n"})}),"\n",(0,s.jsxs)(o.ol,{start:"3",children:["\n",(0,s.jsx)(o.li,{children:"Unload the topic to clear the cache on the broker"}),"\n"]}),"\n",(0,s.jsx)(o.pre,{children:(0,s.jsx)(o.code,{className:"language-shell",children:"bin/pulsar-admin topics unload {topic}\n"})})]})}function p(e={}){const{wrapper:o}={...(0,t.R)(),...e.components};return o?(0,s.jsx)(o,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,o,c)=>{c.d(o,{R:()=>a,x:()=>i});var n=c(96540);const s={},t=n.createContext(s);function a(e){const o=n.useContext(t);return n.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),n.createElement(t.Provider,{value:o},e.children)}}}]);