"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[8830],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=c(n),m=r,d=h["".concat(s,".").concat(m)]||h[m]||u[m]||i;return n?a.createElement(d,o(o({ref:t},p),{},{components:n})):a.createElement(d,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4155:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const i={id:"security-tls-authentication",title:"Authentication using TLS",sidebar_label:"Authentication using TLS",original_id:"security-tls-authentication"},o=void 0,l={unversionedId:"security-tls-authentication",id:"version-2.4.0/security-tls-authentication",title:"Authentication using TLS",description:"TLS Authentication Overview",source:"@site/versioned_docs/version-2.4.0/security-tls-authentication.md",sourceDirName:".",slug:"/security-tls-authentication",permalink:"/docs/2.4.0/security-tls-authentication",draft:!1,editUrl:"https://github.com/apache/pulsar/edit/master/site2/docs/security-tls-authentication.md",tags:[],version:"2.4.0",frontMatter:{id:"security-tls-authentication",title:"Authentication using TLS",sidebar_label:"Authentication using TLS",original_id:"security-tls-authentication"},sidebar:"version-2.4.0/docsSidebar",previous:{title:"Transport Encryption using TLS",permalink:"/docs/2.4.0/security-tls-transport"},next:{title:"Client Authentication using tokens",permalink:"/docs/2.4.0/security-token-client"}},s={},c=[{value:"TLS Authentication Overview",id:"tls-authentication-overview",level:2},{value:"Creating client certificates",id:"creating-client-certificates",level:3},{value:"Enabling TLS Authentication ...",id:"enabling-tls-authentication-",level:2},{value:"... on Brokers",id:"-on-brokers",level:3},{value:"... on Proxies",id:"-on-proxies",level:3},{value:"Client configuration",id:"client-configuration",level:2},{value:"CLI tools",id:"cli-tools",level:3},{value:"Java client",id:"java-client",level:3},{value:"Python client",id:"python-client",level:3},{value:"C++ client",id:"c-client",level:3}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"tls-authentication-overview"},"TLS Authentication Overview"),(0,r.kt)("p",null,"TLS authentication is an extension of ",(0,r.kt)("a",{parentName:"p",href:"security-tls-transport"},"TLS transport encryption"),", but instead of only servers having keys and certs which the client uses to verify the server's identity, clients also have keys and certs which the server uses to verify the client's identity. You must have TLS transport encryption configured on your cluster before you can use TLS authentication. This guide assumes you already have TLS transport encryption configured."),(0,r.kt)("h3",{id:"creating-client-certificates"},"Creating client certificates"),(0,r.kt)("p",null,"Client certificates are generated using the same certificate authority as was used to generate the server certificates."),(0,r.kt)("p",null,"The biggest difference between client certs and server certs is that the ",(0,r.kt)("strong",{parentName:"p"},"common name")," for the client certificate is the ",(0,r.kt)("strong",{parentName:"p"},"role token")," which that client will be authenticated as."),(0,r.kt)("p",null,"First generate the key."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ openssl genrsa -out admin.key.pem 2048\n\n")),(0,r.kt)("p",null,"Similar to the broker, the client expects the key to be in ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/PKCS_8"},"PKCS 8")," format, so convert it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ openssl pkcs8 -topk8 -inform PEM -outform PEM \\\n      -in admin.key.pem -out admin.key-pk8.pem -nocrypt\n\n")),(0,r.kt)("p",null,"Generate the certificate request. When asked for a ",(0,r.kt)("strong",{parentName:"p"},"common name"),", enter the ",(0,r.kt)("strong",{parentName:"p"},"role token")," which you want this key pair to authenticate a client as."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ openssl req -config openssl.cnf \\\n      -key admin.key.pem -new -sha256 -out admin.csr.pem\n\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If there is no openssl.cnf, please read ",(0,r.kt)("a",{parentName:"p",href:"http://pulsar.apache.org/docs/en/security-tls-transport/#certificate-authority"},"Certificate authority")," to get the openssl.cnf."))),(0,r.kt)("p",null,"Sign with request with the certificate authority. Note that that client certs uses the ",(0,r.kt)("strong",{parentName:"p"},"usr_cert")," extension, which allows the cert to be used for client authentication."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ openssl ca -config openssl.cnf -extensions usr_cert \\\n      -days 1000 -notext -md sha256 \\\n      -in admin.csr.pem -out admin.cert.pem\n\n")),(0,r.kt)("p",null,"This will give you a cert, ",(0,r.kt)("inlineCode",{parentName:"p"},"admin.cert.pem"),", and a key, ",(0,r.kt)("inlineCode",{parentName:"p"},"admin.key-pk8.pem"),", which, with ",(0,r.kt)("inlineCode",{parentName:"p"},"ca.cert.pem"),", can be used by clients to authenticate themselves to brokers and proxies as the role token ",(0,r.kt)("inlineCode",{parentName:"p"},"admin"),"."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},'If got "unable to load CA private key" error and the reason is "No such file or directory: /etc/pki/CA/private/cakey.pem" in this step. Please try :'),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ cd /etc/pki/tls/misc/CA\n$ ./CA -newca\n\n")),(0,r.kt)("p",{parentName:"div"},"to generate ",(0,r.kt)("inlineCode",{parentName:"p"},"cakey.pem")," ."))),(0,r.kt)("h2",{id:"enabling-tls-authentication-"},"Enabling TLS Authentication ..."),(0,r.kt)("h3",{id:"-on-brokers"},"... on Brokers"),(0,r.kt)("p",null,"To configure brokers to authenticate clients, put the following in ",(0,r.kt)("inlineCode",{parentName:"p"},"broker.conf"),", alongside ",(0,r.kt)("a",{parentName:"p",href:"/docs/2.4.0/security-tls-transport#broker-configuration"},"the configuration to enable tls transport"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-properties"},"\n# Configuration to enable authentication\nauthenticationEnabled=true\nauthenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderTls\n\n# operations and publish/consume from all topics\nsuperUserRoles=admin\n\n# Authentication settings of the broker itself. Used when the broker connects to other brokers, either in same or other clusters\nbrokerClientTlsEnabled=true\nbrokerClientAuthenticationPlugin=org.apache.pulsar.client.impl.auth.AuthenticationTls\nbrokerClientAuthenticationParameters=tlsCertFile:/path/my-ca/admin.cert.pem,tlsKeyFile:/path/my-ca/admin.key-pk8.pem\nbrokerClientTrustCertsFilePath=/path/my-ca/certs/ca.cert.pem\n\n")),(0,r.kt)("h3",{id:"-on-proxies"},"... on Proxies"),(0,r.kt)("p",null,"To configure proxies to authenticate clients, put the following in ",(0,r.kt)("inlineCode",{parentName:"p"},"proxy.conf"),", alongside ",(0,r.kt)("a",{parentName:"p",href:"/docs/2.4.0/security-tls-transport#proxy-configuration"},"the configuration to enable tls transport"),":"),(0,r.kt)("p",null,"The proxy should have its own client key pair for connecting to brokers. The role token for this key pair should be configured in the ",(0,r.kt)("inlineCode",{parentName:"p"},"proxyRoles")," of the brokers. See the ",(0,r.kt)("a",{parentName:"p",href:"security-authorization"},"authorization guide")," for more details."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-properties"},"\n# For clients connecting to the proxy\nauthenticationEnabled=true\nauthenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderTls\n\n# For the proxy to connect to brokers\nbrokerClientAuthenticationPlugin=org.apache.pulsar.client.impl.auth.AuthenticationTls\nbrokerClientAuthenticationParameters=tlsCertFile:/path/to/proxy.cert.pem,tlsKeyFile:/path/to/proxy.key-pk8.pem\n\n")),(0,r.kt)("h2",{id:"client-configuration"},"Client configuration"),(0,r.kt)("p",null,"When TLS authentication, the client needs to connect via TLS transport, so you need to configure the client to use ",(0,r.kt)("inlineCode",{parentName:"p"},"https://")," and port 8443 for the web service URL, and ",(0,r.kt)("inlineCode",{parentName:"p"},"pulsar+ssl://")," and port 6651 for the broker service URL."),(0,r.kt)("h3",{id:"cli-tools"},"CLI tools"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"/docs/2.4.0/reference-cli-tools"},"Command-line tools")," like ",(0,r.kt)("a",{parentName:"p",href:"reference-pulsar-admin"},(0,r.kt)("inlineCode",{parentName:"a"},"pulsar-admin")),", ",(0,r.kt)("a",{parentName:"p",href:"/docs/2.4.0/reference-cli-tools#pulsar-perf"},(0,r.kt)("inlineCode",{parentName:"a"},"pulsar-perf")),", and ",(0,r.kt)("a",{parentName:"p",href:"/docs/2.4.0/reference-cli-tools#pulsar-client"},(0,r.kt)("inlineCode",{parentName:"a"},"pulsar-client"))," use the ",(0,r.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," config file in a Pulsar installation."),(0,r.kt)("p",null,"You'll need to add the following parameters to that file to use TLS authentication with Pulsar's CLI tools:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-properties"},"\nwebServiceUrl=https://broker.example.com:8443/\nbrokerServiceUrl=pulsar+ssl://broker.example.com:6651/\nuseTls=true\ntlsAllowInsecureConnection=false\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\nauthPlugin=org.apache.pulsar.client.impl.auth.AuthenticationTls\nauthParams=tlsCertFile:/path/to/my-role.cert.pem,tlsKeyFile:/path/to/my-role.key-pk8.pem\n\n")),(0,r.kt)("h3",{id:"java-client"},"Java client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.client.api.PulsarClient;\n\nPulsarClient client = PulsarClient.builder()\n    .serviceUrl("pulsar+ssl://broker.example.com:6651/")\n    .enableTls(true)\n    .tlsTrustCertsFilePath("/path/to/ca.cert.pem")\n    .authentication("org.apache.pulsar.client.impl.auth.AuthenticationTls",\n                    "tlsCertFile:/path/to/my-role.cert.pem,tlsKeyFile:/path/to/my-role.key-pk8.pem")\n    .build();\n\n')),(0,r.kt)("h3",{id:"python-client"},"Python client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'\nfrom pulsar import Client, AuthenticationTLS\n\nauth = AuthenticationTLS("/path/to/my-role.cert.pem", "/path/to/my-role.key-pk8.pem")\nclient = Client("pulsar+ssl://broker.example.com:6651/",\n                tls_trust_certs_file_path="/path/to/ca.cert.pem",\n                tls_allow_insecure_connection=False,\n                authentication=auth)\n\n')),(0,r.kt)("h3",{id:"c-client"},"C++ client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-c++"},'\n#include <pulsar/Client.h>\n\npulsar::ClientConfiguration config;\nconfig.setUseTls(true);\nconfig.setTlsTrustCertsFilePath("/path/to/ca.cert.pem");\nconfig.setTlsAllowInsecureConnection(false);\n\npulsar::AuthenticationPtr auth = pulsar::AuthTls::create("/path/to/my-role.cert.pem",\n                                                         "/path/to/my-role.key-pk8.pem")\nconfig.setAuth(auth);\n\npulsar::Client client("pulsar+ssl://broker.example.com:6651/", config);\n\n')))}u.isMDXComponent=!0}}]);