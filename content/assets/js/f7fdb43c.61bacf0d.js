"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[50220],{58092:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"security-kerberos","title":"Authentication using Kerberos","description":"Kerberos is a network authentication protocol. It is designed to provide strong authentication for client/server applications by using secret-key cryptography.","source":"@site/versioned_docs/version-2.4.0/security-kerberos.md","sourceDirName":".","slug":"/security-kerberos","permalink":"/docs/2.4.0/security-kerberos","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-2.4.0/security-kerberos.md","tags":[],"version":"2.4.0","frontMatter":{"id":"security-kerberos","title":"Authentication using Kerberos","sidebar_label":"Authentication using Kerberos","original_id":"security-kerberos"},"sidebar":"docsSidebar","previous":{"title":"Authentication using Athenz","permalink":"/docs/2.4.0/security-athenz"},"next":{"title":"Authentication using JWT","permalink":"/docs/2.4.0/security-jwt"}}');var a=r(74848),o=r(28453);const t={id:"security-kerberos",title:"Authentication using Kerberos",sidebar_label:"Authentication using Kerberos",original_id:"security-kerberos"},s=void 0,c={},l=[{value:"Configuration for Kerberos between Client and Broker",id:"configuration-for-kerberos-between-client-and-broker",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Kerberos Principals",id:"kerberos-principals",level:4},{value:"Configure how to connect to KDC",id:"configure-how-to-connect-to-kdc",level:4},{value:"JAAS configuration file",id:"jaas-configuration-file",level:4},{value:"Kerberos configuration for Brokers",id:"kerberos-configuration-for-brokers",level:3},{value:"Configure <code>broker.conf</code> file",id:"configure-brokerconf-file",level:4},{value:"Set Broker JVM parameter",id:"set-broker-jvm-parameter",level:4},{value:"Kerberos configuration for clients",id:"kerberos-configuration-for-clients",level:3},{value:"Java Client and Java Admin Client",id:"java-client-and-java-admin-client",level:4},{value:"Configure CLI tools",id:"configure-cli-tools",level:4},{value:"Kerberos configuration for working with Pulsar Proxy",id:"kerberos-configuration-for-working-with-pulsar-proxy",level:2},{value:"Create principal for Pulsar Proxy in Kerberos",id:"create-principal-for-pulsar-proxy-in-kerberos",level:3},{value:"Add a section in JAAS configuration file for Pulsar Proxy",id:"add-a-section-in-jaas-configuration-file-for-pulsar-proxy",level:3},{value:"Proxy Client configuration",id:"proxy-client-configuration",level:3},{value:"Kerberos configuration for Pulsar Proxy service",id:"kerberos-configuration-for-pulsar-proxy-service",level:3},{value:"Broker side configuration.",id:"broker-side-configuration",level:3},{value:"Regarding authorization and role token",id:"regarding-authorization-and-role-token",level:2},{value:"Regarding authentication between ZooKeeper and Broker",id:"regarding-authentication-between-zookeeper-and-broker",level:2},{value:"Regarding authentication between BookKeeper and Broker",id:"regarding-authentication-between-bookkeeper-and-broker",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://web.mit.edu/kerberos/",children:"Kerberos"})," is a network authentication protocol. It is designed to provide strong authentication for client/server applications by using secret-key cryptography."]}),"\n",(0,a.jsxs)(n.p,{children:["In Pulsar, we use Kerberos with ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer",children:"SASL"})," as a choice for authentication. And Pulsar uses the ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Java_Authentication_and_Authorization_Service",children:"Java Authentication and Authorization Service (JAAS)"})," for SASL configuration. You must provide JAAS configurations for Kerberos authentication."]}),"\n",(0,a.jsxs)(n.p,{children:["In this document, we will introduce how to configure ",(0,a.jsx)(n.code,{children:"Kerberos"})," with ",(0,a.jsx)(n.code,{children:"SASL"})," between Pulsar clients and brokers in detail, and then how to configure Kerberos for Pulsar proxy."]}),"\n",(0,a.jsx)(n.h2,{id:"configuration-for-kerberos-between-client-and-broker",children:"Configuration for Kerberos between Client and Broker"}),"\n",(0,a.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.p,{children:["To begin, you need to set up(or already have) a ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Key_distribution_center",children:"Key Distribution Center(KDC)"})," configured and running."]}),"\n",(0,a.jsxs)(n.p,{children:["If your organization is already using a Kerberos server (for example, by using ",(0,a.jsx)(n.code,{children:"Active Directory"}),"), there is no need to install a new server for Pulsar. Otherwise you will need to install one. Your Linux vendor likely has packages for ",(0,a.jsx)(n.code,{children:"Kerberos"})," and a short guide on how to install and configure it: (",(0,a.jsx)(n.a,{href:"https://help.ubuntu.com/community/Kerberos",children:"Ubuntu"}),",\n",(0,a.jsx)(n.a,{href:"https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Managing_Smart_Cards/installing-kerberos.html",children:"Redhat"}),")."]}),"\n",(0,a.jsxs)(n.p,{children:["Note that if you are using Oracle Java, you need to download JCE policy files for your Java version and copy them to the ",(0,a.jsx)(n.code,{children:"$JAVA_HOME/jre/lib/security"})," directory."]}),"\n",(0,a.jsx)(n.h4,{id:"kerberos-principals",children:"Kerberos Principals"}),"\n",(0,a.jsx)(n.p,{children:"If you are using existing Kerberos system, ask your Kerberos administrator for a principal for each Brokers in your cluster and for every operating system user that will access Pulsar with Kerberos authentication(via clients and tools)."}),"\n",(0,a.jsx)(n.p,{children:"If you have installed your own Kerberos system, you can create these principals with the following commands:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n### add Principals for broker\nsudo /usr/sbin/kadmin.local -q 'addprinc -randkey broker/{hostname}@{REALM}'\nsudo /usr/sbin/kadmin.local -q \"ktadd -k /etc/security/keytabs/{broker-keytabname}.keytab broker/{hostname}@{REALM}\"\n### add Principals for client\nsudo /usr/sbin/kadmin.local -q 'addprinc -randkey client/{hostname}@{REALM}'\nsudo /usr/sbin/kadmin.local -q \"ktadd -k /etc/security/keytabs/{client-keytabname}.keytab client/{hostname}@{REALM}\"\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Note that it is a ",(0,a.jsx)(n.em,{children:"Kerberos"})," requirement that all your hosts can be resolved with their FQDNs."]}),"\n",(0,a.jsxs)(n.p,{children:["The first part of Broker principal (for example, ",(0,a.jsx)(n.code,{children:"broker"})," in ",(0,a.jsx)(n.code,{children:"broker/{hostname}@{REALM}"}),") is the ",(0,a.jsx)(n.code,{children:"serverType"})," of each host,\nThe suggested values of ",(0,a.jsx)(n.code,{children:"serverType"})," are ",(0,a.jsx)(n.code,{children:"broker"})," (host machine runs service Pulsar Broker) and ",(0,a.jsx)(n.code,{children:"proxy"})," (host machine runs service Pulsar Proxy)."]}),"\n",(0,a.jsx)(n.h4,{id:"configure-how-to-connect-to-kdc",children:"Configure how to connect to KDC"}),"\n",(0,a.jsxs)(n.p,{children:["You need to specify the path to the ",(0,a.jsx)(n.code,{children:"krb5.conf"})," file for both client and broker side. The contents of ",(0,a.jsx)(n.code,{children:"krb5.conf"})," file indicate the default Realm and KDC information. See ",(0,a.jsx)(n.a,{href:"https://docs.oracle.com/javase/8/docs/technotes/guides/security/jgss/tutorials/KerberosReq.html",children:"JDK\u2019s Kerberos Requirements"})," for more details."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n-Djava.security.krb5.conf=/etc/pulsar/krb5.conf\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Here is an example of the krb5.conf file:"}),"\n",(0,a.jsxs)(n.p,{children:["In the configuration file, ",(0,a.jsx)(n.code,{children:"EXAMPLE.COM"})," is the default realm; ",(0,a.jsx)(n.code,{children:"kdc = localhost:62037"})," is the kdc server url for realm ",(0,a.jsx)(n.code,{children:"EXAMPLE.COM "}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\n[libdefaults]\n default_realm = EXAMPLE.COM\n\n[realms]\n EXAMPLE.COM  = {\n  kdc = localhost:62037\n }\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Usually machines configured with kerberos already have a system wide configuration and this configuration is optional."}),"\n",(0,a.jsx)(n.h4,{id:"jaas-configuration-file",children:"JAAS configuration file"}),"\n",(0,a.jsxs)(n.p,{children:["JAAS configuration file is needed for both client and broker sides. It provides the section of information that used to connect KDC. Here is an example named ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\n PulsarBroker {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarbroker.keytab"\n   principal="broker/localhost@EXAMPLE.COM";\n};\n\n PulsarClient {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarclient.keytab"\n   principal="client/localhost@EXAMPLE.COM";\n};\n\n'})}),"\n",(0,a.jsxs)(n.p,{children:["You need to set the ",(0,a.jsx)(n.code,{children:"JAAS"})," configuration file path as JVM parameter for client and broker. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n    -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"})," file above"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"PulsarBroker"})," is a section name in the JAAS file used by each broker. This section tells the broker which principal to use inside Kerberos\nand the location of the keytab where the principal is stored. It allows the broker to use the keytab specified in this section."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"PulsarClient"})," is a section name in the JASS file used by each client. This section tells the client which principal to use inside Kerberos\nand the location of the keytab where the principal is stored. It allows the client to use the keytab specified in this section.\nIn the following example, this ",(0,a.jsx)(n.code,{children:"PulsarClient"})," section will also be reused in both the Pulsar internal admin configuration and in CLI command of ",(0,a.jsx)(n.code,{children:"bin/pulsar-client"}),", ",(0,a.jsx)(n.code,{children:"bin/pulsar-perf"})," and ",(0,a.jsx)(n.code,{children:"bin/pulsar-admin"}),". You can also add different sections for different use cases."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"You can have 2 separate JAAS configuration files:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["the file for a broker has sections of both ",(0,a.jsx)(n.code,{children:"PulsarBroker"})," and ",(0,a.jsx)(n.code,{children:"PulsarClient"}),";"]}),"\n",(0,a.jsxs)(n.li,{children:["the file for a client only has a ",(0,a.jsx)(n.code,{children:"PulsarClient"})," section."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"kerberos-configuration-for-brokers",children:"Kerberos configuration for Brokers"}),"\n",(0,a.jsxs)(n.h4,{id:"configure-brokerconf-file",children:["Configure ",(0,a.jsx)(n.code,{children:"broker.conf"})," file"]}),"\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"broker.conf"})," file, set Kerberos related configurations."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"authenticationEnabled"})," to ",(0,a.jsx)(n.code,{children:"true"}),";"]}),"\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"authenticationProviders"})," to choose ",(0,a.jsx)(n.code,{children:"AuthenticationProviderSasl"}),";"]}),"\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"saslJaasClientAllowedIds"})," regex for principal that is allowed to connect to broker;"]}),"\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"saslJaasBrokerSectionName"})," that corresponding to the section in JAAS configuration file for broker;"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["To make Pulsar internal admin client work properly, you need to set the configuration in the ",(0,a.jsx)(n.code,{children:"broker.conf"})," file as below:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"brokerClientAuthenticationPlugin"})," to client plugin ",(0,a.jsx)(n.code,{children:"AuthenticationSasl"}),";"]}),"\n",(0,a.jsxs)(n.li,{children:["Set ",(0,a.jsx)(n.code,{children:"brokerClientAuthenticationParameters"})," to value in JSON string ",(0,a.jsx)(n.code,{children:'{"saslJaasClientSectionName":"PulsarClient", "serverType":"broker"}'}),", in which ",(0,a.jsx)(n.code,{children:"PulsarClient"})," is the section name in above ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"})," file, and ",(0,a.jsx)(n.code,{children:'"serverType":"broker"'})," indicate that internal admin client will connect to a Pulsar Broker;"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Here is an example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\nauthenticationEnabled=true\nauthenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderSasl\nsaslJaasClientAllowedIds=.*client.*\nsaslJaasBrokerSectionName=PulsarBroker\n\n## Authentication settings of the broker itself. Used when the broker connects to other brokers\nbrokerClientAuthenticationPlugin=org.apache.pulsar.client.impl.auth.AuthenticationSasl\nbrokerClientAuthenticationParameters={"saslJaasClientSectionName":"PulsarClient", "serverType":"broker"}\n\n'})}),"\n",(0,a.jsx)(n.h4,{id:"set-broker-jvm-parameter",children:"Set Broker JVM parameter"}),"\n",(0,a.jsx)(n.p,{children:"Set JVM parameters for JAAS configuration file and krb5 configuration file with additional options."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n   -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf -Djava.security.krb5.conf=/etc/pulsar/krb5.conf\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can add this at the end of ",(0,a.jsx)(n.code,{children:"PULSAR_EXTRA_OPTS"})," in the file ",(0,a.jsx)(n.a,{href:"https://github.com/apache/pulsar/blob/master/conf/pulsar_env.sh",children:(0,a.jsx)(n.code,{children:"pulsar_env.sh"})})]}),"\n",(0,a.jsxs)(n.p,{children:["Make sure that the keytabs configured in the ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"})," file and kdc server in the ",(0,a.jsx)(n.code,{children:"krb5.conf"})," file are reachable by the operating system user who is starting broker."]}),"\n",(0,a.jsx)(n.h3,{id:"kerberos-configuration-for-clients",children:"Kerberos configuration for clients"}),"\n",(0,a.jsx)(n.h4,{id:"java-client-and-java-admin-client",children:"Java Client and Java Admin Client"}),"\n",(0,a.jsxs)(n.p,{children:["In client application, include ",(0,a.jsx)(n.code,{children:"pulsar-client-auth-sasl"})," in your project dependency."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\n    <dependency>\n      <groupId>org.apache.pulsar</groupId>\n      <artifactId>pulsar-client-auth-sasl</artifactId>\n      <version>${pulsar.version}</version>\n    </dependency>\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["configure the authentication type to use ",(0,a.jsx)(n.code,{children:"AuthenticationSasl"}),", and also provide the authentication parameters to it."]}),"\n",(0,a.jsx)(n.p,{children:"There are 2 parameters needed:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"saslJaasClientSectionName"})," is corresponding to the section in JAAS configuration file for client;"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"serverType"})," stands for whether this client is connect to broker or proxy, and client use this parameter to know which server side principal should be used."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["When authenticate between client and broker with the setting in above JAAS configuration file, we need to set ",(0,a.jsx)(n.code,{children:"saslJaasClientSectionName"})," to ",(0,a.jsx)(n.code,{children:"PulsarClient"})," and ",(0,a.jsx)(n.code,{children:"serverType"})," to ",(0,a.jsx)(n.code,{children:"broker"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"The following is an example of creating a Java client:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'\nSystem.setProperty("java.security.auth.login.config", "/etc/pulsar/pulsar_jaas.conf");\nSystem.setProperty("java.security.krb5.conf", "/etc/pulsar/krb5.conf");\n\nMap<String, String> authParams = Maps.newHashMap();\nauthParams.put("saslJaasClientSectionName", "PulsarClient");\nauthParams.put("serverType", "broker");\n\nAuthentication saslAuth = AuthenticationFactory\n        .create(org.apache.pulsar.client.impl.auth.AuthenticationSasl.class.getName(), authParams);\n\nPulsarClient client = PulsarClient.builder()\n        .serviceUrl("pulsar://my-broker.com:6650")\n        .authentication(saslAuth)\n        .build();\n\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"The first two lines in the example above are hard coded, alternatively, you can set additional JVM parameters for JAAS and krb5 configuration file when running the application like below:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\njava -cp -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf -Djava.security.krb5.conf=/etc/pulsar/krb5.conf $APP-jar-with-dependencies.jar $CLASSNAME\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Make sure that the keytabs configured in the ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"})," file and kdc server in the ",(0,a.jsx)(n.code,{children:"krb5.conf"})," file are reachable by the operating system user who is starting pulsar client."]}),"\n",(0,a.jsx)(n.h4,{id:"configure-cli-tools",children:"Configure CLI tools"}),"\n",(0,a.jsxs)(n.p,{children:["If you are using a command-line tool (such as ",(0,a.jsx)(n.code,{children:"bin/pulsar-client"}),", ",(0,a.jsx)(n.code,{children:"bin/pulsar-perf"})," and ",(0,a.jsx)(n.code,{children:"bin/pulsar-admin"}),"), you need to perform the following steps:"]}),"\n",(0,a.jsxs)(n.p,{children:["Step 1. Config your ",(0,a.jsx)(n.code,{children:"client.conf"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'\nauthPlugin=org.apache.pulsar.client.impl.auth.AuthenticationSasl\nauthParams={"saslJaasClientSectionName":"PulsarClient", "serverType":"broker"}\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Step 2. Set JVM parameters for JAAS configuration file and krb5 configuration file with additional options."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n   -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf -Djava.security.krb5.conf=/etc/pulsar/krb5.conf\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can add this at the end of ",(0,a.jsx)(n.code,{children:"PULSAR_EXTRA_OPTS"})," in the file ",(0,a.jsx)(n.a,{href:"https://github.com/apache/pulsar/blob/master/conf/pulsar_tools_env.sh",children:(0,a.jsx)(n.code,{children:"pulsar_tools_env.sh"})}),",\nor add this line ",(0,a.jsx)(n.code,{children:'OPTS="$OPTS -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf -Djava.security.krb5.conf=/etc/pulsar/krb5.conf "'})," directly to the CLI tool script."]}),"\n",(0,a.jsx)(n.p,{children:"The meaning of configurations is the same as that in Java client section."}),"\n",(0,a.jsx)(n.h2,{id:"kerberos-configuration-for-working-with-pulsar-proxy",children:"Kerberos configuration for working with Pulsar Proxy"}),"\n",(0,a.jsx)(n.p,{children:"With the above configuration, client and broker can do authentication using Kerberos."}),"\n",(0,a.jsx)(n.p,{children:"If a client wants to connect to Pulsar Proxy, it is a little different. Client (as a SASL client in Kerberos) will be authenticated by Pulsar Proxy (as a SASL Server in Kerberos) first; and then Pulsar Proxy will be authenticated by Pulsar broker."}),"\n",(0,a.jsx)(n.p,{children:"Now comparing with the above configuration between client and broker, we will show how to configure Pulsar Proxy."}),"\n",(0,a.jsx)(n.h3,{id:"create-principal-for-pulsar-proxy-in-kerberos",children:"Create principal for Pulsar Proxy in Kerberos"}),"\n",(0,a.jsx)(n.p,{children:"Comparing with the above configuration, you need to add new principal for Pulsar Proxy. If you already have principals for client and broker, only add proxy principal here."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\n### add Principals for Pulsar Proxy\nsudo /usr/sbin/kadmin.local -q 'addprinc -randkey proxy/{hostname}@{REALM}'\nsudo /usr/sbin/kadmin.local -q \"ktadd -k /etc/security/keytabs/{proxy-keytabname}.keytab proxy/{hostname}@{REALM}\"\n### add Principals for broker\nsudo /usr/sbin/kadmin.local -q 'addprinc -randkey broker/{hostname}@{REALM}'\nsudo /usr/sbin/kadmin.local -q \"ktadd -k /etc/security/keytabs/{broker-keytabname}.keytab broker/{hostname}@{REALM}\"\n### add Principals for client\nsudo /usr/sbin/kadmin.local -q 'addprinc -randkey client/{hostname}@{REALM}'\nsudo /usr/sbin/kadmin.local -q \"ktadd -k /etc/security/keytabs/{client-keytabname}.keytab client/{hostname}@{REALM}\"\n\n"})}),"\n",(0,a.jsx)(n.h3,{id:"add-a-section-in-jaas-configuration-file-for-pulsar-proxy",children:"Add a section in JAAS configuration file for Pulsar Proxy"}),"\n",(0,a.jsx)(n.p,{children:"Comparing with the above configuration, add a new section for Pulsar Proxy in JAAS configuration file."}),"\n",(0,a.jsxs)(n.p,{children:["Here is an example named ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\n PulsarBroker {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarbroker.keytab"\n   principal="broker/localhost@EXAMPLE.COM";\n};\n\n PulsarProxy {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarproxy.keytab"\n   principal="proxy/localhost@EXAMPLE.COM";\n};\n\n PulsarClient {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarclient.keytab"\n   principal="client/localhost@EXAMPLE.COM";\n};\n\n'})}),"\n",(0,a.jsx)(n.h3,{id:"proxy-client-configuration",children:"Proxy Client configuration"}),"\n",(0,a.jsxs)(n.p,{children:["Pulsar client configuration is similar with client and broker configuration, except that ",(0,a.jsx)(n.code,{children:"serverType"})," is set to ",(0,a.jsx)(n.code,{children:"proxy"})," instead of ",(0,a.jsx)(n.code,{children:"broker"}),", because it needs to do Kerberos authentication between client and proxy."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'\nSystem.setProperty("java.security.auth.login.config", "/etc/pulsar/pulsar_jaas.conf");\nSystem.setProperty("java.security.krb5.conf", "/etc/pulsar/krb5.conf");\n\nMap<String, String> authParams = Maps.newHashMap();\nauthParams.put("saslJaasClientSectionName", "PulsarClient");\nauthParams.put("serverType", "proxy");        // ** here is the different **\n\nAuthentication saslAuth = AuthenticationFactory\n        .create(org.apache.pulsar.client.impl.auth.AuthenticationSasl.class.getName(), authParams);\n\nPulsarClient client = PulsarClient.builder()\n        .serviceUrl("pulsar://my-broker.com:6650")\n        .authentication(saslAuth)\n        .build();\n\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"The first two lines in the example above are hard coded, alternatively, you can set additional JVM parameters for JAAS and krb5 configuration file when running the application like below:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\njava -cp -Djava.security.auth.login.config=/etc/pulsar/pulsar_jaas.conf -Djava.security.krb5.conf=/etc/pulsar/krb5.conf $APP-jar-with-dependencies.jar $CLASSNAME\n\n"})}),"\n",(0,a.jsx)(n.h3,{id:"kerberos-configuration-for-pulsar-proxy-service",children:"Kerberos configuration for Pulsar Proxy service"}),"\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"proxy.conf"})," file, set Kerberos related configuration. Here is an example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'\n## related to authenticate client.\nauthenticationEnabled=true\nauthenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderSasl\nsaslJaasClientAllowedIds=.*client.*\nsaslJaasBrokerSectionName=PulsarProxy\n\n## related to be authenticated by broker\nbrokerClientAuthenticationPlugin=org.apache.pulsar.client.impl.auth.AuthenticationSasl\nbrokerClientAuthenticationParameters={"saslJaasClientSectionName":"PulsarProxy", "serverType":"broker"}\nforwardAuthorizationCredentials=true\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"The first part is related to authenticate between client and Pulsar Proxy. In this phase, client works as SASL client, while Pulsar Proxy works as SASL server."}),"\n",(0,a.jsx)(n.p,{children:"The second part is related to authenticate between Pulsar Proxy and Pulsar Broker. In this phase, Pulsar Proxy works as SASL client, while Pulsar Broker works as SASL server."}),"\n",(0,a.jsx)(n.h3,{id:"broker-side-configuration",children:"Broker side configuration."}),"\n",(0,a.jsxs)(n.p,{children:["The broker side configuration file is the same with the above ",(0,a.jsx)(n.code,{children:"broker.conf"}),", you do not need special configuration for Pulsar Proxy."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\nauthenticationEnabled=true\nauthenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderSasl\nsaslJaasClientAllowedIds=.*client.*\nsaslJaasBrokerSectionName=PulsarBroker\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"regarding-authorization-and-role-token",children:"Regarding authorization and role token"}),"\n",(0,a.jsxs)(n.p,{children:["For Kerberos authentication, the authenticated principal is used as the role token for Pulsar authorization.  For more information of authorization in Pulsar, see ",(0,a.jsx)(n.a,{href:"/docs/2.4.0/security-authorization",children:"security authorization"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["If you enabled authorizationEnabled you need set ",(0,a.jsx)(n.code,{children:"superUserRoles"})," in ",(0,a.jsx)(n.code,{children:"broker.conf"})," that corresponding to the name registered in kdc"]}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"\nsuperUserRoles=client/{clientIp}@EXAMPLE.COM\n\n"})}),"\n",(0,a.jsx)(n.h2,{id:"regarding-authentication-between-zookeeper-and-broker",children:"Regarding authentication between ZooKeeper and Broker"}),"\n",(0,a.jsxs)(n.p,{children:["Pulsar Broker acts as a Kerberos client when authenticating with Zookeeper. According to ",(0,a.jsx)(n.a,{href:"https://cwiki.apache.org/confluence/display/ZOOKEEPER/Client-Server+mutual+authentication",children:"ZooKeeper document"}),", you need these settings in ",(0,a.jsx)(n.code,{children:"conf/zookeeper.conf"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\nauthProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider\nrequireClientAuthScheme=sasl\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["And add a section of ",(0,a.jsx)(n.code,{children:"Client"})," configurations in the file ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"}),", which is used by Pulsar Broker:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\n Client {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarbroker.keytab"\n   principal="broker/localhost@EXAMPLE.COM";\n};\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"In this setting, Pulsar Broker's principal and keyTab file indicates Broker's role when authenticating with ZooKeeper."}),"\n",(0,a.jsx)(n.h2,{id:"regarding-authentication-between-bookkeeper-and-broker",children:"Regarding authentication between BookKeeper and Broker"}),"\n",(0,a.jsxs)(n.p,{children:["Pulsar Broker acts as a Kerberos client when authenticating with Bookie. According to ",(0,a.jsx)(n.a,{href:"http://bookkeeper.apache.org/docs/latest/security/sasl/",children:"BookKeeper document"}),", you need to add ",(0,a.jsx)(n.code,{children:"bookkeeperClientAuthenticationPlugin"})," parameter in ",(0,a.jsx)(n.code,{children:"broker.conf"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\nbookkeeperClientAuthenticationPlugin=org.apache.bookkeeper.sasl.SASLClientProviderFactory\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In this setting, ",(0,a.jsx)(n.code,{children:"SASLClientProviderFactory"})," creates a BookKeeper SASL client in a Broker, and the Broker uses the created SASL client to authenticate with a Bookie node."]}),"\n",(0,a.jsxs)(n.p,{children:["And add a section of ",(0,a.jsx)(n.code,{children:"BookKeeper"})," configurations in the ",(0,a.jsx)(n.code,{children:"pulsar_jaas.conf"})," that used by Pulsar Broker:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\n BookKeeper {\n   com.sun.security.auth.module.Krb5LoginModule required\n   useKeyTab=true\n   storeKey=true\n   useTicketCache=false\n   keyTab="/etc/security/keytabs/pulsarbroker.keytab"\n   principal="broker/localhost@EXAMPLE.COM";\n};\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"In this setting, Pulsar Broker's principal and keyTab file indicates Broker's role when authenticating with Bookie."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>s});var i=r(96540);const a={},o=i.createContext(a);function t(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);