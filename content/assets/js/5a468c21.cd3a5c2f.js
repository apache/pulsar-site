"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[83202],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>k});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(n),k=a,d=m["".concat(s,".").concat(k)]||m[k]||u[k]||i;return n?r.createElement(d,o(o({ref:t},p),{},{components:n})):r.createElement(d,o({ref:t},p))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(67294),a=n(86010);const i="tabItem_Ymn6";function o(e){let{children:t,hidden:n,className:o}=e;return r.createElement("div",{role:"tabpanel",className:(0,a.Z)(i,o),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>k});var r=n(87462),a=n(67294),i=n(86010),o=n(72389),l=n(67392),s=n(7094),c=n(12466);const p="tabList__CuJ",u="tabItem_LNqP";function m(e){const{lazy:t,block:n,defaultValue:o,values:m,groupId:k,className:d}=e,h=a.Children.map(e.children,(e=>{if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),f=m??h.map((e=>{let{props:{value:t,label:n,attributes:r}}=e;return{value:t,label:n,attributes:r}})),y=(0,l.l)(f,((e,t)=>e.value===t.value));if(y.length>0)throw new Error(`Docusaurus error: Duplicate values "${y.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const b=null===o?o:o??h.find((e=>e.props.default))?.props.value??h[0].props.value;if(null!==b&&!f.some((e=>e.value===b)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${b}" but none of its children has the corresponding value. Available values are: ${f.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:v,setTabGroupChoices:g}=(0,s.U)(),[C,N]=(0,a.useState)(b),S=[],{blockElementScrollPositionUntilNextRender:T}=(0,c.o5)();if(null!=k){const e=v[k];null!=e&&e!==C&&f.some((t=>t.value===e))&&N(e)}const w=e=>{const t=e.currentTarget,n=S.indexOf(t),r=f[n].value;r!==C&&(T(t),N(r),null!=k&&g(k,String(r)))},P=e=>{let t=null;switch(e.key){case"Enter":w(e);break;case"ArrowRight":{const n=S.indexOf(e.currentTarget)+1;t=S[n]??S[0];break}case"ArrowLeft":{const n=S.indexOf(e.currentTarget)-1;t=S[n]??S[S.length-1];break}}t?.focus()};return a.createElement("div",{className:(0,i.Z)("tabs-container",p)},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},d)},f.map((e=>{let{value:t,label:n,attributes:o}=e;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:C===t?0:-1,"aria-selected":C===t,key:t,ref:e=>S.push(e),onKeyDown:P,onClick:w},o,{className:(0,i.Z)("tabs__item",u,o?.className,{"tabs__item--active":C===t})}),n??t)}))),t?(0,a.cloneElement)(h.filter((e=>e.props.value===C))[0],{className:"margin-top--md"}):a.createElement("div",{className:"margin-top--md"},h.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==C})))))}function k(e){const t=(0,o.Z)();return a.createElement(m,(0,r.Z)({key:String(t)},e))}},49358:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>k,frontMatter:()=>l,metadata:()=>c,toc:()=>u});var r=n(87462),a=(n(67294),n(3905)),i=n(65488),o=n(85162);const l={id:"security-tls-transport",title:"TLS Encryption",sidebar_label:"TLS Encryption"},s=void 0,c={unversionedId:"security-tls-transport",id:"security-tls-transport",title:"TLS Encryption",description:"TLS overview",source:"@site/docs/security-tls-transport.md",sourceDirName:".",slug:"/security-tls-transport",permalink:"/docs/next/security-tls-transport",draft:!1,editUrl:"https://github.com/apache/pulsar/edit/master/site2/docs/security-tls-transport.md",tags:[],version:"current",frontMatter:{id:"security-tls-transport",title:"TLS Encryption",sidebar_label:"TLS Encryption"},sidebar:"docsSidebar",previous:{title:"End-to-End Encryption",permalink:"/docs/next/security-encryption"},next:{title:"Bouncy Castle Providers",permalink:"/docs/next/security-bouncy-castle"}},p={},u=[{value:"TLS overview",id:"tls-overview",level:2},{value:"TLS certificates",id:"tls-certificates",level:3},{value:"Certificate formats",id:"certificate-formats",level:3},{value:"Hostname verification",id:"hostname-verification",level:3},{value:"Configure TLS encryption with PEM",id:"configure-tls-encryption-with-pem",level:2},{value:"Create TLS certificates",id:"create-tls-certificates",level:3},{value:"Create a certificate authority",id:"create-a-certificate-authority",level:4},{value:"Create a server certificate",id:"create-a-server-certificate",level:4},{value:"Create a client certificate",id:"create-a-client-certificate",level:4},{value:"Configure brokers",id:"configure-brokers",level:3},{value:"Configure TLS Protocol Version and Cipher",id:"configure-tls-protocol-version-and-cipher",level:4},{value:"Configure proxies",id:"configure-proxies",level:3},{value:"Configure clients",id:"configure-clients",level:3},{value:"Configure CLI tools",id:"configure-cli-tools",level:3},{value:"Configure TLS encryption with KeyStore",id:"configure-tls-encryption-with-keystore",level:2},{value:"Generate JKS certificate",id:"generate-jks-certificate",level:3},{value:"Configure brokers",id:"configure-brokers-1",level:3},{value:"Configure proxies",id:"configure-proxies-1",level:3},{value:"Configure clients",id:"configure-clients-1",level:3},{value:"Configure CLI tools",id:"configure-cli-tools-1",level:3},{value:"Enable TLS Logging",id:"enable-tls-logging",level:2}],m={toc:u};function k(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"tls-overview"},"TLS overview"),(0,a.kt)("p",null,"Transport Layer Security (TLS) is a form of ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Public-key_cryptography"},"public key cryptography"),". By default, Pulsar clients communicate with Pulsar services in plain text. This means that all data is sent in the clear. You can use TLS to encrypt this traffic to protect the traffic from the snooping of a man-in-the-middle attacker."),(0,a.kt)("p",null,"This section introduces how to configure TLS encryption in Pulsar. For how to configure TLS authentication in Pulsar, refer to ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/security-tls-authentication"},"TLS authentication"),". Alternatively, you can use another ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/security-athenz"},"Athenz authentication")," on top of TLS transport encryption."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Enabling TLS encryption may impact the performance due to encryption overhead.")),(0,a.kt)("h3",{id:"tls-certificates"},"TLS certificates"),(0,a.kt)("p",null,"TLS certificates include the following three types. Each certificate (key pair) contains both a public key that encrypts messages and a private key that decrypts messages."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Certificate Authority (CA)",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"CA private key is distributed to all parties involved."),(0,a.kt)("li",{parentName:"ul"},"CA public key (",(0,a.kt)("strong",{parentName:"li"},"trust cert"),") is used for signing a certificate for either broker or clients."))),(0,a.kt)("li",{parentName:"ul"},"Server key pairs"),(0,a.kt)("li",{parentName:"ul"},"Client key pairs (for mutual TLS)")),(0,a.kt)("p",null,"For both server and client certificates, the private key with a certificate request is generated first, and the public key (the certificate) is generated after the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," signs the certificate request. When ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/security-tls-authentication"},"TLS authentication")," is enabled, the server uses the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," to verify that the client has a key pair that the certificate authority signs. The Common Name (CN) of a client certificate is used as the client's role token, while the Subject Alternative Name (SAN) of a server certificate is used for ",(0,a.kt)("a",{parentName:"p",href:"#hostname-verification"},"Hostname verification"),"."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The validity of these certificates is 365 days. It's highly recommended to use ",(0,a.kt)("inlineCode",{parentName:"p"},"sha256")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"sha512")," as the signature algorithm, while ",(0,a.kt)("inlineCode",{parentName:"p"},"sha1")," is not supported.")),(0,a.kt)("h3",{id:"certificate-formats"},"Certificate formats"),(0,a.kt)("p",null,"You can use either one of the following certificate formats to configure TLS encryption:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Recommended: Privacy Enhanced Mail (PEM).\nSee ",(0,a.kt)("a",{parentName:"li",href:"#configure-tls-encryption-with-pem"},"Configure TLS encryption with PEM")," for detailed instructions."),(0,a.kt)("li",{parentName:"ul"},"Optional: Java ",(0,a.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Java_KeyStore"},"KeyStore")," (JKS).\nSee ",(0,a.kt)("a",{parentName:"li",href:"#configure-tls-encryption-with-keystore"},"Configure TLS encryption with KeyStore")," for detailed instructions.")),(0,a.kt)("h3",{id:"hostname-verification"},"Hostname verification"),(0,a.kt)("p",null,"Hostname verification is a TLS security feature whereby a client can refuse to connect to a server if the Subject Alternative Name (SAN) does not match the hostname that the hostname is connecting to. "),(0,a.kt)("p",null,"By default, Pulsar clients disable hostname verification, as it requires that each broker has a DNS record and a unique cert."),(0,a.kt)("p",null,"One scenario where you may want to enable hostname verification is where you have multiple proxy nodes behind a VIP, and the VIP has a DNS record, for example, ",(0,a.kt)("inlineCode",{parentName:"p"},"pulsar.mycompany.com"),". In this case, you can generate a TLS cert with ",(0,a.kt)("inlineCode",{parentName:"p"},"pulsar.mycompany.com")," as the SAN, and then enable hostname verification on the client."),(0,a.kt)("p",null,"To enable hostname verification in Pulsar, ensure that SAN exactly matches the fully qualified domain name (FQDN) of the server. The client compares the SAN with the DNS domain name to ensure that it is connecting to the desired server. See ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/security-tls-transport#configure-clients"},"Configure clients")," for more details."),(0,a.kt)("p",null,"Moreover, as the administrator has full control of the CA, a bad actor is unlikely to be able to pull off a man-in-the-middle attack. ",(0,a.kt)("inlineCode",{parentName:"p"},"allowInsecureConnection")," allows the client to connect to servers whose cert has not been signed by an approved CA. The client disables ",(0,a.kt)("inlineCode",{parentName:"p"},"allowInsecureConnection")," by default, and you should always disable ",(0,a.kt)("inlineCode",{parentName:"p"},"allowInsecureConnection")," in production environments. As long as you disable ",(0,a.kt)("inlineCode",{parentName:"p"},"allowInsecureConnection"),", a man-in-the-middle attack requires that the attacker has access to the CA."),(0,a.kt)("h2",{id:"configure-tls-encryption-with-pem"},"Configure TLS encryption with PEM"),(0,a.kt)("p",null,"By default, Pulsar uses ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/netty/netty-tcnative"},"netty-tcnative"),". It includes two implementations, ",(0,a.kt)("inlineCode",{parentName:"p"},"OpenSSL")," (default) and ",(0,a.kt)("inlineCode",{parentName:"p"},"JDK"),". When ",(0,a.kt)("inlineCode",{parentName:"p"},"OpenSSL")," is unavailable, ",(0,a.kt)("inlineCode",{parentName:"p"},"JDK")," is used."),(0,a.kt)("h3",{id:"create-tls-certificates"},"Create TLS certificates"),(0,a.kt)("p",null,"Creating TLS certificates involves creating a ",(0,a.kt)("a",{parentName:"p",href:"#create-a-certificate-authority"},"certificate authority"),", a ",(0,a.kt)("a",{parentName:"p",href:"#create-a-server-certificate"},"server certificate"),", and a ",(0,a.kt)("a",{parentName:"p",href:"#create-a-client-certificate"},"client certificate"),". "),(0,a.kt)("h4",{id:"create-a-certificate-authority"},"Create a certificate authority"),(0,a.kt)("p",null,"You can use a certificate authority (CA) to sign both server and client certificates. This ensures that each party trusts the others. Store CA in a very secure location (ideally completely disconnected from networks, air-gapped, and fully encrypted)."),(0,a.kt)("p",null,"Use the following command to create a CA."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'openssl genrsa -out ca.key.pem 2048\nopenssl req -x509 -new -nodes -key ca.key.pem -subj "/CN=CARoot" -days 365 -out ca.cert.pem\n')),(0,a.kt)("p",null,"   :::note"),(0,a.kt)("p",null,"   The default ",(0,a.kt)("inlineCode",{parentName:"p"},"openssl")," on macOS doesn't work for the commands above. You need to upgrade ",(0,a.kt)("inlineCode",{parentName:"p"},"openssl")," via Homebrew:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'brew install openssl\nexport PATH="/usr/local/Cellar/openssl@3/3.0.1/bin:$PATH"\n')),(0,a.kt)("p",null,"   Use the actual path from the output of the ",(0,a.kt)("inlineCode",{parentName:"p"},"brew install")," command. Note that version number ",(0,a.kt)("inlineCode",{parentName:"p"},"3.0.1")," might change. "),(0,a.kt)("p",null,"   :::"),(0,a.kt)("h4",{id:"create-a-server-certificate"},"Create a server certificate"),(0,a.kt)("p",null,"Once you have created a CA, you can create certificate requests and sign them with the CA."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate the server's private key."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out broker.key.pem 2048\n")),(0,a.kt)("p",{parentName:"li"},"The broker expects the key to be in ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/PKCS_8"},"PKCS 8")," format. Enter the following command to convert it."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl pkcs8 -topk8 -inform PEM -outform PEM -in broker.key.pem -out broker.key-pk8.pem -nocrypt\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.conf")," file with the following content:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"[ req ]\ndefault_bits = 2048\nprompt = no\ndefault_md = sha256\ndistinguished_name = dn\n\n[ v3_ext ]\nauthorityKeyIdentifier=keyid,issuer:always\nbasicConstraints=CA:FALSE\nkeyUsage=critical, digitalSignature, keyEncipherment\nextendedKeyUsage=serverAuth\nsubjectAltName=@alt_names\n\n[ dn ]\nCN = broker\n\n[ alt_names ]\nDNS.1 = pulsar\nDNS.2 = pulsar.default\nIP.1 = 127.0.0.1\nIP.2 = 192.168.1.2\n")),(0,a.kt)("admonition",{parentName:"li",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"To configure ",(0,a.kt)("a",{parentName:"p",href:"#hostname-verification"},"hostname verification"),", you need to enter the hostname of the broker in ",(0,a.kt)("inlineCode",{parentName:"p"},"alt_names")," as the Subject Alternative Name (SAN). To ensure that multiple machines can reuse the same certificate, you can also use a wildcard to match a group of broker hostnames, for example, ",(0,a.kt)("inlineCode",{parentName:"p"},"*.broker.usw.example.com"),"."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate the certificate request."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -new -config broker.conf -key broker.key.pem -out broker.csr.pem -sha256\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Sign the certificate with the CA."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in broker.csr.pem -CA ca.cert.pem -CAkey ca.key.pem -CAcreateserial -out broker.cert.pem -days 365 -extensions v3_ext -extfile broker.conf -sha256\n")))),(0,a.kt)("p",null,"At this point, you have a cert, ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.cert.pem"),", and a key, ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.key-pk8.pem"),", which you can use along with ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.cert.pem")," to configure TLS encryption for your brokers and proxies."),(0,a.kt)("h4",{id:"create-a-client-certificate"},"Create a client certificate"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate the client's private key."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out client.key.pem 2048\n")),(0,a.kt)("p",{parentName:"li"},"The client expects the key to be in ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/PKCS_8"},"PKCS 8")," format. Enter the following command to convert it."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl pkcs8 -topk8 -inform PEM -outform PEM -in client.key.pem -out client.key-pk8.pem -nocrypt\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate the certificate request. Note that the value of ",(0,a.kt)("inlineCode",{parentName:"p"},"CN")," is used as the client's role token."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -new -subj "/CN=client" -key client.key.pem -out client.csr.pem -sha256\n'))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Sign the certificate with the CA."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in client.csr.pem -CA ca.cert.pem -CAkey ca.key.pem -CAcreateserial -out client.cert.pem -days 365 -sha256\n")))),(0,a.kt)("p",null,"At this point, you have a cert ",(0,a.kt)("inlineCode",{parentName:"p"},"client.cert.pem")," and a key ",(0,a.kt)("inlineCode",{parentName:"p"},"client.key-pk8.pem"),", which you can use along with ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.cert.pem")," to configure TLS encryption for your clients."),(0,a.kt)("h3",{id:"configure-brokers"},"Configure brokers"),(0,a.kt)("p",null,"To configure a Pulsar ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-terminology#broker"},"broker")," to use TLS encryption, you need to add these values to ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.conf")," in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf")," directory of your Pulsar installation. Substitute the appropriate certificate paths where necessary."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"brokerServicePortTls=6651\nwebServicePortTls=8081\ntlsRequireTrustedClientCertOnConnect=true\ntlsCertificateFilePath=/path/to/broker.cert.pem\ntlsKeyFilePath=/path/to/broker.key-pk8.pem\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\n\nbrokerClientTlsEnabled=true\nbrokerClientTrustCertsFilePath=/path/to/ca.cert.pem\nbrokerClientCertificateFilePath=/path/to/client.cert.pem\nbrokerClientKeyFilePath=/path/to/client.key-pk8.pem\n")),(0,a.kt)("h4",{id:"configure-tls-protocol-version-and-cipher"},"Configure TLS Protocol Version and Cipher"),(0,a.kt)("p",null,"To configure the broker (and proxy) to require specific TLS protocol versions and ciphers for TLS negotiation, you can use the TLS protocol versions and ciphers to stop clients from requesting downgraded TLS protocol versions or ciphers that may have weaknesses."),(0,a.kt)("p",null,"By default, Pulsar uses OpenSSL when it is available, otherwise, Pulsar defaults back to the JDK implementation. OpenSSL currently supports ",(0,a.kt)("inlineCode",{parentName:"p"},"TLSv1.1"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"TLSv1.2")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"TLSv1.3"),". You can acquire a list of supported ciphers from the OpenSSL ciphers command, i.e. ",(0,a.kt)("inlineCode",{parentName:"p"},"openssl ciphers -tls1_3"),"."),(0,a.kt)("p",null,"Both the TLS protocol versions and cipher properties can take multiple values, separated by commas. The possible values for protocol versions and ciphers depend on the TLS provider that you are using. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"tlsProtocols=TLSv1.3,TLSv1.2\ntlsCiphers=TLS_DH_RSA_WITH_AES_256_GCM_SHA384,TLS_DH_RSA_WITH_AES_256_CBC_SHA\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"tlsProtocols=TLSv1.3,TLSv1.2"),": List out the TLS protocols that you are going to accept from clients. By default, it is not set."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"tlsCiphers=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"),": A cipher suite is a named combination of authentication, encryption, MAC and key exchange algorithm used to negotiate the security settings for a network connection using TLS network protocol. By default, it is null. See ",(0,a.kt)("a",{parentName:"li",href:"https://www.openssl.org/docs/man1.0.2/apps/ciphers.html"},"OpenSSL Ciphers")," and ",(0,a.kt)("a",{parentName:"li",href:"http://docs.oracle.com/javase/8/docs/technotes/guides/security/StandardNames.html#ciphersuites"},"JDK Ciphers")," for more details.")),(0,a.kt)("p",null,"For JDK 11, you can obtain a list of supported values from the documentation:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.oracle.com/en/java/javase/11/security/oracle-providers.html#GUID-7093246A-31A3-4304-AC5F-5FB6400405E2__SUNJSSEPROVIDERPROTOCOLPARAMETERS-BBF75009"},"TLS protocol")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.oracle.com/en/java/javase/11/security/oracle-providers.html#GUID-7093246A-31A3-4304-AC5F-5FB6400405E2__SUNJSSE_CIPHER_SUITES"},"Ciphers"))),(0,a.kt)("h3",{id:"configure-proxies"},"Configure proxies"),(0,a.kt)("p",null,"Configuring TLS on proxies includes two directions of connections, from clients to proxies, and from proxies to brokers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"servicePortTls=6651\nwebServicePortTls=8081\n\n# For clients connecting to the proxy\ntlsRequireTrustedClientCertOnConnect=true\ntlsCertificateFilePath=/path/to/broker.cert.pem\ntlsKeyFilePath=/path/to/broker.key-pk8.pem\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\n\n# For the proxy to connect to brokers\ntlsEnabledWithBroker=true\nbrokerClientTrustCertsFilePath=/path/to/ca.cert.pem\nbrokerClientCertificateFilePath=/path/to/client.cert.pem\nbrokerClientKeyFilePath=/path/to/client.key-pk8.pem\n")),(0,a.kt)("h3",{id:"configure-clients"},"Configure clients"),(0,a.kt)("p",null,"To enable TLS encryption, you need to configure the clients to use ",(0,a.kt)("inlineCode",{parentName:"p"},"https://")," with port 8443 for the web service URL, and ",(0,a.kt)("inlineCode",{parentName:"p"},"pulsar+ssl://")," with port 6651 for the broker service URL."),(0,a.kt)("p",null,"As the server certificate that you generated above does not belong to any of the default trust chains, you also need to either specify the path of the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," (recommended) or enable the clients to allow untrusted server certs."),(0,a.kt)("p",null,"The following examples show how to configure TLS encryption for Java/Python/C++/Node.js/C#/WebSocket clients."),(0,a.kt)(i.Z,{groupId:"lang-choice",defaultValue:"Java",values:[{label:"Java",value:"Java"},{label:"Python",value:"Python"},{label:"C++",value:"C++"},{label:"Node.js",value:"Node.js"},{label:"C#",value:"C#"},{label:"WebSocket API",value:"WebSocket API"}],mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Java",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.pulsar.client.api.PulsarClient;\n\nPulsarClient client = PulsarClient.builder()\n    .serviceUrl("pulsar+ssl://broker.example.com:6651/")\n    .tlsKeyFilePath("/path/to/client.key-pk8.pem")\n    .tlsCertificateFilePath("/path/to/client.cert.pem")\n    .tlsTrustCertsFilePath("/path/to/ca.cert.pem")\n    .enableTlsHostnameVerification(false) // false by default, in any case\n    .allowTlsInsecureConnection(false) // false by default, in any case\n    .build();\n'))),(0,a.kt)(o.Z,{value:"Python",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'from pulsar import Client\n\nclient = Client("pulsar+ssl://broker.example.com:6651/",\n                tls_hostname_verification=False,\n                tls_trust_certs_file_path="/path/to/ca.cert.pem",\n                tls_allow_insecure_connection=False) // defaults to false from v2.2.0 onwards\n'))),(0,a.kt)(o.Z,{value:"C++",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cpp"},"#include <pulsar/Client.h>\n\nClientConfiguration config = ClientConfiguration();\nconfig.setUseTls(true);  // shouldn't be needed soon\nconfig.setTlsTrustCertsFilePath(caPath);\nconfig.setTlsAllowInsecureConnection(false);\nconfig.setAuth(pulsar::AuthTls::create(clientPublicKeyPath, clientPrivateKeyPath));\nconfig.setValidateHostName(false);\n"))),(0,a.kt)(o.Z,{value:"Node.js",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const Pulsar = require('pulsar-client');\n\n(async () => {\n  const client = new Pulsar.Client({\n    serviceUrl: 'pulsar+ssl://broker.example.com:6651/',\n    tlsTrustCertsFilePath: '/path/to/ca.cert.pem',\n    useTls: true,\n    tlsValidateHostname: false,\n    tlsAllowInsecureConnection: false,\n  });\n})();\n"))),(0,a.kt)(o.Z,{value:"C#",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"var certificate = new X509Certificate2(\"ca.cert.pem\");\nvar client = PulsarClient.Builder()\n                         .TrustedCertificateAuthority(certificate) //If the CA is not trusted on the host, you can add it explicitly.\n                         .VerifyCertificateAuthority(true) //Default is 'true'\n                         .VerifyCertificateName(false)     //Default is 'false'\n                         .Build();\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Note that ",(0,a.kt)("inlineCode",{parentName:"p"},"VerifyCertificateName")," refers to the configuration of hostname verification in the C# client."))),(0,a.kt)(o.Z,{value:"WebSocket API",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'import websockets\nimport asyncio\nimport base64\nimport json\nimport ssl\nimport pathlib\n\nssl_context = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)\nclient_cert_pem = pathlib.Path(__file__).with_name("client.cert.pem")\nclient_key_pem = pathlib.Path(__file__).with_name("client.key.pem")\nca_cert_pem = pathlib.Path(__file__).with_name("ca.cert.pem")\nssl_context.load_cert_chain(certfile=client_cert_pem, keyfile=client_key_pem)\nssl_context.load_verify_locations(ca_cert_pem)\n# websocket producer uri wss, not ws\nuri = "wss://localhost:8080/ws/v2/producer/persistent/public/default/testtopic"\nclient_pem = pathlib.Path(__file__).with_name("pulsar_client.pem")\nssl_context.load_verify_locations(client_pem)\n# websocket producer uri wss, not ws\nuri = "wss://localhost:8080/ws/v2/producer/persistent/public/default/testtopic"\n# encode message\ns = "Hello World"\nfirstEncoded = s.encode("UTF-8")\nbinaryEncoded = base64.b64encode(firstEncoded)\npayloadString = binaryEncoded.decode(\'UTF-8\')\nasync def producer_handler(websocket):\n    await websocket.send(json.dumps({\n            \'payload\' : payloadString,\n            \'properties\': {\n                \'key1\' : \'value1\',\n                \'key2\' : \'value2\'\n            },\n            \'context\' : 5\n        }))\nasync def test():\n    async with websockets.connect(uri) as websocket:\n        await producer_handler(websocket)\n        message = await websocket.recv()\n        print(f"< {message}")\nasyncio.run(test())\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Note that in addition to the required configurations in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," file, you need to configure more parameters in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/broker.conf")," file to enable TLS encryption on WebSocket service. For more details, see ",(0,a.kt)("a",{parentName:"p",href:"client-libraries-websocket.md/#security-settings"},"security settings for WebSocket"),".")))),(0,a.kt)("h3",{id:"configure-cli-tools"},"Configure CLI tools"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-cli-tools"},"Command-line tools")," like ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-cli-tools"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-admin")),", ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-cli-tools"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-perf")),", and ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-cli-tools"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-client"))," use the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," config file in a Pulsar installation."),(0,a.kt)("p",null,"To use TLS encryption with Pulsar CLI tools, you need to add the following parameters to the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"webServiceUrl=https://broker.example.com:8443/\nbrokerServiceUrl=pulsar+ssl://broker.example.com:6651/\ntlsAllowInsecureConnection=false\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\ntlsKeyFilePath=/path/to/client.key-pk8.pem\ntlsCertFile=/path/to/client-cert.pem\ntlsEnableHostnameVerification=false\n")),(0,a.kt)("h2",{id:"configure-tls-encryption-with-keystore"},"Configure TLS encryption with KeyStore"),(0,a.kt)("p",null,"By default, Pulsar uses ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/google/conscrypt"},"Conscrypt")," for both broker service and Web service."),(0,a.kt)("h3",{id:"generate-jks-certificate"},"Generate JKS certificate"),(0,a.kt)("p",null,"You can use Java\u2019s ",(0,a.kt)("inlineCode",{parentName:"p"},"keytool")," utility to generate the key and certificate for each machine in the cluster. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"DAYS=365\nCLIENT_COMMON_PARAMS=\"-storetype JKS -storepass clientpw -keypass clientpw -noprompt\"\nBROKER_COMMON_PARAMS=\"-storetype JKS -storepass brokerpw -keypass brokerpw -noprompt\"\n\n# create keystore\nkeytool -genkeypair -keystore broker.keystore.jks ${BROKER_COMMON_PARAMS} -keyalg RSA -keysize 2048 -alias broker -validity $DAYS \\\n-dname 'CN=broker,OU=Unknown,O=Unknown,L=Unknown,ST=Unknown,C=Unknown'\nkeytool -genkeypair -keystore client.keystore.jks ${CLIENT_COMMON_PARAMS} -keyalg RSA -keysize 2048 -alias client -validity $DAYS \\\n-dname 'CN=client,OU=Unknown,O=Unknown,L=Unknown,ST=Unknown,C=Unknown'\n\n# export certificate \nkeytool -exportcert -keystore broker.keystore.jks ${BROKER_COMMON_PARAMS} -file broker.cer -alias broker\nkeytool -exportcert -keystore client.keystore.jks ${CLIENT_COMMON_PARAMS} -file client.cer -alias client\n \n# generate truststore\nkeytool -importcert -keystore client.truststore.jks ${CLIENT_COMMON_PARAMS} -file broker.cer -alias truststore\nkeytool -importcert -keystore broker.truststore.jks ${BROKER_COMMON_PARAMS} -file client.cer -alias truststore\n")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"To configure ",(0,a.kt)("a",{parentName:"p",href:"#hostname-verification"},"hostname verification"),", you need to append ",(0,a.kt)("inlineCode",{parentName:"p"}," -ext SAN=IP:127.0.0.1,IP:192.168.20.2,DNS:broker.example.com")," to the value of ",(0,a.kt)("inlineCode",{parentName:"p"},"BROKER_COMMON_PARAMS")," as the Subject Alternative Name (SAN).")),(0,a.kt)("h3",{id:"configure-brokers-1"},"Configure brokers"),(0,a.kt)("p",null,"Configure the following parameters in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/broker.conf")," file and restrict access to the store files via filesystem permissions."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"brokerServicePortTls=6651\nwebServicePortTls=8081\n\n# Trusted client certificates are required to connect TLS\n# Reject the Connection if the Client Certificate is not trusted.\n# In effect, this requires that all connecting clients perform TLS client\n# authentication.\ntlsRequireTrustedClientCertOnConnect=true\ntlsEnabledWithKeyStore=true\n\n# key store\ntlsKeyStoreType=JKS\ntlsKeyStore=/var/private/tls/broker.keystore.jks\ntlsKeyStorePassword=brokerpw\n\n# trust store\ntlsTrustStoreType=JKS\ntlsTrustStore=/var/private/tls/broker.truststore.jks\ntlsTrustStorePassword=brokerpw\n\n# internal client/admin-client config\nbrokerClientTlsEnabled=true\nbrokerClientTlsEnabledWithKeyStore=true\nbrokerClientTlsTrustStoreType=JKS\nbrokerClientTlsTrustStore=/var/private/tls/client.truststore.jks\nbrokerClientTlsTrustStorePassword=clientpw\nbrokerClientTlsKeyStoreType=JKS\nbrokerClientTlsKeyStore=/var/private/tls/client.keystore.jks\nbrokerClientTlsKeyStorePassword=clientpw\n")),(0,a.kt)("p",null,"To disable non-TLS ports, you need to set the values of ",(0,a.kt)("inlineCode",{parentName:"p"},"brokerServicePort")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"webServicePort")," to empty."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The default value of ",(0,a.kt)("inlineCode",{parentName:"p"},"tlsRequireTrustedClientCertOnConnect")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),". When it's enabled for mutual TLS, brokers/proxies require trusted client certificates; otherwise, brokers/proxies reject connection requests from clients.")),(0,a.kt)("h3",{id:"configure-proxies-1"},"Configure proxies"),(0,a.kt)("p",null,"Configuring TLS on proxies includes two directions of connections, from clients to proxies, and from proxies to brokers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"servicePortTls=6651\nwebServicePortTls=8081\n \ntlsRequireTrustedClientCertOnConnect=true\n \n# keystore\ntlsKeyStoreType=JKS\ntlsKeyStore=/var/private/tls/proxy.keystore.jks\ntlsKeyStorePassword=brokerpw\n \n# truststore\ntlsTrustStoreType=JKS\ntlsTrustStore=/var/private/tls/proxy.truststore.jks\ntlsTrustStorePassword=brokerpw\n \n# internal client/admin-client config\ntlsEnabledWithKeyStore=true\nbrokerClientTlsEnabled=true\nbrokerClientTlsEnabledWithKeyStore=true\nbrokerClientTlsTrustStoreType=JKS\nbrokerClientTlsTrustStore=/var/private/tls/client.truststore.jks\nbrokerClientTlsTrustStorePassword=clientpw\nbrokerClientTlsKeyStoreType=JKS\nbrokerClientTlsKeyStore=/var/private/tls/client.keystore.jks\nbrokerClientTlsKeyStorePassword=clientpw\n")),(0,a.kt)("h3",{id:"configure-clients-1"},"Configure clients"),(0,a.kt)("p",null,"Similar to ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/security-tls-transport#configure-clients"},"Configure TLS encryption with PEM"),", you need to provide the TrustStore information for a minimal configuration."),(0,a.kt)("p",null,"The following is an example."),(0,a.kt)(i.Z,{groupId:"lang-choice",defaultValue:"Java client",values:[{label:"Java client",value:"Java client"},{label:"Java admin client",value:"Java admin client"}],mdxType:"Tabs"},(0,a.kt)(o.Z,{value:"Java client",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'    import org.apache.pulsar.client.api.PulsarClient;\n\n    PulsarClient client = PulsarClient.builder()\n        .serviceUrl("pulsar+ssl://broker.example.com:6651/")\n        .useKeyStoreTls(true)\n        .tlsTrustStoreType("JKS")\n        .tlsTrustStorePath("/var/private/tls/client.truststore.jks")\n        .tlsTrustStorePassword("clientpw")\n        .tlsKeyStoreType("JKS")\n        .tlsKeyStorePath("/var/private/tls/client.keystore.jks")\n        .tlsKeyStorePassword("clientpw")\n        .enableTlsHostnameVerification(false) // false by default, in any case\n        .allowTlsInsecureConnection(false) // false by default, in any case\n        .build();\n'))),(0,a.kt)(o.Z,{value:"Java admin client",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'    PulsarAdmin amdin = PulsarAdmin.builder().serviceHttpUrl("https://broker.example.com:8443")\n        .tlsTrustStoreType("JKS")\n        .tlsTrustStorePath("/var/private/tls/client.truststore.jks")\n        .tlsTrustStorePassword("clientpw")\n        .tlsKeyStoreType("JKS")\n        .tlsKeyStorePath("/var/private/tls/client.keystore.jks")\n        .tlsKeyStorePassword("clientpw")\n        .enableTlsHostnameVerification(false) // false by default, in any case\n        .allowTlsInsecureConnection(false) // false by default, in any case\n        .build();\n')))),(0,a.kt)("h3",{id:"configure-cli-tools-1"},"Configure CLI tools"),(0,a.kt)("p",null,"For ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/reference-cli-tools"},"Command-line tools")," like ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-admin"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-admin")),", ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-perf"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-perf")),", and ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-client"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-client"))," use the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," config file in a Pulsar installation."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"webServiceUrl=https://broker.example.com:8443/\nbrokerServiceUrl=pulsar+ssl://broker.example.com:6651/\nuseKeyStoreTls=true\ntlsTrustStoreType=JKS\ntlsTrustStorePath=/var/private/tls/client.truststore.jks\ntlsTrustStorePassword=clientpw\ntlsKeyStoreType=JKS\ntlsKeyStorePath=/var/private/tls/client.keystore.jks\nkeyStorePassword=clientpw\n")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"If you set ",(0,a.kt)("inlineCode",{parentName:"p"},"useKeyStoreTls")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),", be sure to configure ",(0,a.kt)("inlineCode",{parentName:"p"},"tlsTrustStorePath"),".")),(0,a.kt)("h2",{id:"enable-tls-logging"},"Enable TLS Logging"),(0,a.kt)("p",null,"You can enable TLS debug logging at the JVM level by starting the brokers and/or clients with ",(0,a.kt)("inlineCode",{parentName:"p"},"javax.net.debug")," system property. For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"-Djavax.net.debug=all\n")),(0,a.kt)("p",null,"For more details, see ",(0,a.kt)("a",{parentName:"p",href:"http://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ReadDebug.html"},"Oracle documentation"),"."))}k.isMDXComponent=!0}}]);