"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[40273],{51647:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"functions-worker-run-separately","title":"Run function workers separately","description":"The following diagram illustrates how function workers run as a separate process in separate machines.","source":"@site/versioned_docs/version-3.1.x/functions-worker-run-separately.md","sourceDirName":".","slug":"/functions-worker-run-separately","permalink":"/docs/3.1.x/functions-worker-run-separately","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/pulsar-site/edit/main/versioned_docs/version-3.1.x/functions-worker-run-separately.md","tags":[],"version":"3.1.x","frontMatter":{"id":"functions-worker-run-separately","title":"Run function workers separately","sidebar_label":"Run function workers separately"},"sidebar":"docsSidebar","previous":{"title":"Run function workers with brokers","permalink":"/docs/3.1.x/functions-worker-corun"},"next":{"title":"Configure temporary file path","permalink":"/docs/3.1.x/functions-worker-temp-file-path"}}');var i=r(74848),o=r(28453);const s={id:"functions-worker-run-separately",title:"Run function workers separately",sidebar_label:"Run function workers separately"},a=void 0,c={},l=[{value:"Configure function workers to run separately",id:"configure-function-workers-to-run-separately",level:2},{value:"Configure worker parameters",id:"configure-worker-parameters",level:3},{value:"Configure function package parameters",id:"configure-function-package-parameters",level:3},{value:"Configure function metadata parameters",id:"configure-function-metadata-parameters",level:3},{value:"Enable security settings",id:"enable-security-settings",level:3},{value:"Enable TLS encryption",id:"enable-tls-encryption",level:4},{value:"Enable authentication providers",id:"enable-authentication-providers",level:4},{value:"Enable authorization providers",id:"enable-authorization-providers",level:4},{value:"Configure BookKeeper authentication",id:"configure-bookkeeper-authentication",level:3},{value:"Start function workers",id:"start-function-workers",level:2},{value:"Configure proxies for standalone function workers",id:"configure-proxies-for-standalone-function-workers",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"The following diagram illustrates how function workers run as a separate process in separate machines."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"assets/functions-worker-separated.svg",src:r(23840).A+"",width:"1300",height:"543"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Service URLs"})," in the illustration represent Pulsar service URLs that Pulsar client and Pulsar admin use to connect to a Pulsar cluster."]})}),"\n",(0,i.jsx)(n.p,{children:"To set up function workers that run separately, complete the following steps:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#configure-function-workers-to-run-separately",children:"Configure function workers"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#start-function-workers",children:"Start function workers"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#configure-proxies-for-standalone-function-workers",children:"Configure proxies for function workers"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configure-function-workers-to-run-separately",children:"Configure function workers to run separately"}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["To run function workers separately, you need to keep ",(0,i.jsx)(n.code,{children:"functionsWorkerEnabled"})," as its default value (",(0,i.jsx)(n.code,{children:"false"}),") in the ",(0,i.jsx)(n.code,{children:"conf/broker.conf"})," file."]})}),"\n",(0,i.jsx)(n.h3,{id:"configure-worker-parameters",children:"Configure worker parameters"}),"\n",(0,i.jsxs)(n.p,{children:["Configure the required parameters for workers in the ",(0,i.jsx)(n.code,{children:"conf/functions_worker.yml"})," file."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workerId"}),": The identity of a worker node, which is unique across clusters. The type is string."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workerHostname"}),": The hostname of the worker node."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workerPort"}),": The port that the worker server listens on. Keep it as default if you don't customize it. Set it to ",(0,i.jsx)(n.code,{children:"null"})," to disable the plaintext port."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"workerPortTls"}),": The TLS port that the worker server listens on. Keep it as default if you don't customize it. For more information about TLS encryption settings, refer to ",(0,i.jsx)(n.a,{href:"#enable-tls-encryption",children:"settings"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["When accessing function workers to manage functions, the ",(0,i.jsx)(n.code,{children:"pulsar-admin"})," CLI or any of the clients should use the configured ",(0,i.jsx)(n.code,{children:"workerHostname"})," and ",(0,i.jsx)(n.code,{children:"workerPort"})," to generate an ",(0,i.jsx)(n.code,{children:"--admin-url"}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"configure-function-package-parameters",children:"Configure function package parameters"}),"\n",(0,i.jsxs)(n.p,{children:["Configure the ",(0,i.jsx)(n.code,{children:"numFunctionPackageReplicas"})," parameter in the ",(0,i.jsx)(n.code,{children:"conf/functions_worker.yml"})," file. It indicates the number of replicas to store function packages."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["To ensure high availability in a production deployment, set ",(0,i.jsx)(n.code,{children:"numFunctionPackageReplicas"})," to equal the number of bookies. The default value ",(0,i.jsx)(n.code,{children:"1"})," is only for one-node cluster deployment."]})}),"\n",(0,i.jsx)(n.h3,{id:"configure-function-metadata-parameters",children:"Configure function metadata parameters"}),"\n",(0,i.jsxs)(n.p,{children:["Configure the required parameter for function metadata in the ",(0,i.jsx)(n.code,{children:"conf/functions_worker.yml"})," file."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pulsarServiceUrl"}),": The Pulsar service URL for your broker cluster."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pulsarWebServiceUrl"}),": The Pulsar web service URL for your broker cluster."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pulsarFunctionsCluster"}),": Set the value to your Pulsar cluster name (same as the ",(0,i.jsx)(n.code,{children:"clusterName"})," setting in the ",(0,i.jsx)(n.code,{children:"conf/broker.conf"})," file)."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If authentication is enabled on your broker cluster, you must configure the following authentication settings for the function workers to communicate with the brokers."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"brokerClientAuthenticationEnabled"}),": Whether to enable the broker client authentication used by function workers to talk to brokers."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientAuthenticationPlugin"}),": The authentication plugin to be used by the Pulsar client used in worker service."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientAuthenticationParameters"}),": The authentication parameter to be used by the Pulsar client used in worker service."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"enable-security-settings",children:"Enable security settings"}),"\n",(0,i.jsx)(n.p,{children:"When you run a function worker separately in a cluster configured with authentication, your function worker needs to communicate with the broker and authenticate incoming requests. Thus you need to configure the properties that the broker requires for authentication and authorization."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"You must configure both the function worker authentication and authorization for the server to authenticate incoming requests and configure the client to be authenticated to communicate with the broker."})}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you use token authentication, you need to configure the following properties in the ",(0,i.jsx)(n.code,{children:"conf/function-worker.yml"})," file."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'brokerClientAuthenticationPlugin: org.apache.pulsar.client.impl.auth.AuthenticationToken\nbrokerClientAuthenticationParameters: file:///etc/pulsar/token/admin-token.txt\nconfigurationMetadataStoreUrl: zk:zookeeper-cluster:2181 # auth requires a connection to zookeeper\nauthenticationProviders:\n - "org.apache.pulsar.broker.authentication.AuthenticationProviderToken"\nauthorizationEnabled: true\nauthenticationEnabled: true\nsuperUserRoles:\n  - superuser\n  - proxy\nproperties:\n  tokenSecretKey: file:///etc/pulsar/jwt/secret # if using a secret token, key file must be DER-encoded\n  tokenPublicKey: file:///etc/pulsar/jwt/public.key # if using public/private key tokens, key file must be DER-encoded\n'})}),"\n",(0,i.jsx)(n.p,{children:"You can enable the following security settings on function workers."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#enable-tls-encryption",children:"Enable TLS encryption"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#enable-authentication-providers",children:"Enable authentication providers"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#enable-authorization-providers",children:"Enable authorization providers"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/3.1.x/functions-deploy-cluster-encryption",children:"Enable end-to-end encryption"})}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"enable-tls-encryption",children:"Enable TLS encryption"}),"\n",(0,i.jsx)(n.p,{children:"To enable TLS encryption, configure the following settings."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"useTLS: true\npulsarServiceUrl: pulsar+ssl://localhost:6651/\npulsarWebServiceUrl: https://localhost:8443\n\ntlsEnabled: true\ntlsCertificateFilePath: /path/to/functions-worker.cert.pem\ntlsKeyFilePath:         /path/to/functions-worker.key-pk8.pem\ntlsTrustCertsFilePath:  /path/to/ca.cert.pem\n\n// The path to trusted certificates used by the Pulsar client to authenticate with Pulsar brokers\nbrokerClientTrustCertsFilePath: /path/to/ca.cert.pem\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For more details on TLS encryption, refer to ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/security-tls-transport",children:"Transport Encryption using TLS"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"enable-authentication-providers",children:"Enable authentication providers"}),"\n",(0,i.jsxs)(n.p,{children:["To enable authentication providers on function workers, substitute the ",(0,i.jsx)(n.code,{children:"authenticationProviders"})," parameter with the providers you want to enable."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-properties",children:"authenticationEnabled: true\nauthenticationProviders: [provider1, provider2]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/security-tls-authentication",children:"mTLS authentication"})," provider, follow the example below to add the required settings."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-properties",children:"brokerClientAuthenticationPlugin: org.apache.pulsar.client.impl.auth.AuthenticationTls\nbrokerClientAuthenticationParameters: tlsCertFile:/path/to/admin.cert.pem,tlsKeyFile:/path/to/admin.key-pk8.pem\n\nauthenticationEnabled: true\nauthenticationProviders: ['org.apache.pulsar.broker.authentication.AuthenticationProviderTls']\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For SASL authentication provider, add ",(0,i.jsx)(n.code,{children:"saslJaasClientAllowedIds"})," and ",(0,i.jsx)(n.code,{children:"saslJaasServerSectionName"})," under ",(0,i.jsx)(n.code,{children:"properties"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-properties",children:"properties:\n  saslJaasClientAllowedIds: .*pulsar.*\n  saslJaasServerSectionName: Broker\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/security-jwt",children:"token authentication"})," provider, add the required settings under ",(0,i.jsx)(n.code,{children:"properties"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-properties",children:"properties:\n  tokenSecretKey:       file://my/secret.key\n  # If using public/private\n  # tokenPublicKey:     file://path/to/public.key\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Key files must be DER (Distinguished Encoding Rules)-encoded."})}),"\n",(0,i.jsx)(n.h4,{id:"enable-authorization-providers",children:"Enable authorization providers"}),"\n",(0,i.jsx)(n.p,{children:"To enable authorization on function workers, complete the following steps."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Configure ",(0,i.jsx)(n.code,{children:"authorizationEnabled"}),", ",(0,i.jsx)(n.code,{children:"authorizationProvider"})," and ",(0,i.jsx)(n.code,{children:"configurationMetadataStoreUrl"})," in the ",(0,i.jsx)(n.code,{children:"functions_worker.yml"})," file. The authentication provider connects to ",(0,i.jsx)(n.code,{children:"configurationMetadataStoreUrl"})," to receive namespace policies."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"authorizationEnabled: true\nauthorizationProvider: org.apache.pulsar.broker.authorization.PulsarAuthorizationProvider\nconfigurationMetadataStoreUrl: <meta-type>:<configuration-metadata-store-url>\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Configure a list of superuser roles. The superuser roles can access any admin API. The following configuration is an example."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"superUserRoles:\n  - role1\n  - role2\n  - role3\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"configure-bookkeeper-authentication",children:"Configure BookKeeper authentication"}),"\n",(0,i.jsx)(n.p,{children:"If authentication is enabled on the BookKeeper cluster, you need to configure the following BookKeeper authentication settings for your function workers."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"bookkeeperClientAuthenticationPlugin"}),": the authentication plugin name of BookKeeper client."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"bookkeeperClientAuthenticationParametersName"}),": the authentication plugin parameters of BookKeeper client, including names and values."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"bookkeeperClientAuthenticationParameters"}),": the authentication plugin parameters of BookKeeper client."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"start-function-workers",children:"Start function workers"}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Before starting function workers, make sure ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/functions-runtime",children:"function runtime"})," is configured."]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["You can start a function worker in the background by using the ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/reference-cli-tools",children:(0,i.jsx)(n.code,{children:"pulsar-daemon"})})," CLI tool:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"bin/pulsar-daemon start functions-worker\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["To start a function worker in the foreground, you can use the ",(0,i.jsx)(n.a,{href:"pathname:///reference/#/3.1.x/pulsar-admin/",children:(0,i.jsx)(n.code,{children:"pulsar-admin"})})," CLI as follows."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"bin/pulsar functions-worker\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configure-proxies-for-standalone-function-workers",children:"Configure proxies for standalone function workers"}),"\n",(0,i.jsxs)(n.p,{children:["When you are running function workers in a separate cluster, the admin rest endpoints are split into two clusters as shown in the following figure. The ",(0,i.jsx)(n.code,{children:"functions"}),", ",(0,i.jsx)(n.code,{children:"function-worker"}),", ",(0,i.jsx)(n.code,{children:"source"}),", and ",(0,i.jsx)(n.code,{children:"sink"})," endpoints are now served by the worker cluster, while all the other remaining endpoints are served by the broker cluster. This requires you to use the right service URL accordingly in the ",(0,i.jsx)(n.code,{children:"pulsar-admin"})," CLI. To address this inconvenience, you can start a proxy cluster that serves as the central entry point of the admin service for routing admin rest requests."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"assets/functions-worker-separated-proxy.svg",src:r(14574).A+"",width:"1300",height:"851"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["If you haven't set up a proxy cluster yet, follow the ",(0,i.jsx)(n.a,{href:"/docs/3.1.x/administration-proxy",children:"instructions"})," to deploy one."]})}),"\n",(0,i.jsxs)(n.p,{children:["To enable a proxy for routing function-related admin requests to function workers, you can edit the ",(0,i.jsx)(n.code,{children:"conf/proxy.conf"})," file to modify the following settings:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-conf",children:"functionWorkerWebServiceURL=<pulsar-functions-worker-web-service-url>\nfunctionWorkerWebServiceURLTLS=<pulsar-functions-worker-web-service-url>\n"})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},14574:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/function-workers-separated-with-proxy-026953ca9af6f74aafbe947fd6f47796.svg"},23840:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/function-workers-separated-67f57c127c07431c91ef54e0632de4d4.svg"},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>a});var t=r(96540);const i={},o=t.createContext(i);function s(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);